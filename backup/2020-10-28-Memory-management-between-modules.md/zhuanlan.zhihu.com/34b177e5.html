<!doctype html>
<html lang="zh" data-hairline="true" data-theme="light"><head><meta charSet="utf-8"/><title data-react-helmet="true">C 接口中的内存分配释放 - 知乎</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/><meta name="renderer" content="webkit"/><meta name="force-rendering" content="webkit"/><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/><meta name="google-site-verification" content="FTeR0c8arOPKh8c5DYh_9uu98_zJbaWw53J-Sch9MTg"/><meta data-react-helmet="true" name="keywords" content="C / C++,内存管理"/><meta data-react-helmet="true" name="description" content="写代码讲究职责分离，具体到内存，就是谁分配，谁负责释放。这个谁，根据不同的场合，可以是某个函数、某个类、某个组件。 但我们不讨论大而泛的原则，只讨论一个具体的 C 函数。比如路径拼接： const char* path_…"/><meta data-react-helmet="true" property="og:title" content="C 接口中的内存分配释放"/><meta data-react-helmet="true" property="og:url" content="https://zhuanlan.zhihu.com/p/95299255"/><meta data-react-helmet="true" property="og:description" content="写代码讲究职责分离，具体到内存，就是谁分配，谁负责释放。这个谁，根据不同的场合，可以是某个函数、某个类、某个组件。 但我们不讨论大而泛的原则，只讨论一个具体的 C 函数。比如路径拼接： const char* path_…"/><meta data-react-helmet="true" property="og:image" content=""/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" property="og:site_name" content="知乎专栏"/><link data-react-helmet="true" rel="apple-touch-icon" href="https://static.zhihu.com/heifetz/assets/apple-touch-icon-152.67c7b278.png"/><link data-react-helmet="true" rel="apple-touch-icon" href="https://static.zhihu.com/heifetz/assets/apple-touch-icon-152.67c7b278.png" sizes="152x152"/><link data-react-helmet="true" rel="apple-touch-icon" href="https://static.zhihu.com/heifetz/assets/apple-touch-icon-120.b3e6278d.png" sizes="120x120"/><link data-react-helmet="true" rel="apple-touch-icon" href="https://static.zhihu.com/heifetz/assets/apple-touch-icon-76.7a750095.png" sizes="76x76"/><link data-react-helmet="true" rel="apple-touch-icon" href="https://static.zhihu.com/heifetz/assets/apple-touch-icon-60.a4a761d4.png" sizes="60x60"/><link rel="shortcut icon" type="image/x-icon" href="https://static.zhihu.com/static/favicon.ico"/><link rel="search" type="application/opensearchdescription+xml" href="https://static.zhihu.com/static/search.xml" title="知乎"/><link rel="dns-prefetch" href="//static.zhimg.com"/><link rel="dns-prefetch" href="//pic1.zhimg.com"/><link rel="dns-prefetch" href="//pic2.zhimg.com"/><link rel="dns-prefetch" href="//pic3.zhimg.com"/><link rel="dns-prefetch" href="//pic4.zhimg.com"/><style>
.u-safeAreaInset-top {
  height: constant(safe-area-inset-top) !important;
  height: env(safe-area-inset-top) !important;
  
}
.u-safeAreaInset-bottom {
  height: constant(safe-area-inset-bottom) !important;
  height: env(safe-area-inset-bottom) !important;
  
}
</style><link href="https://static.zhihu.com/heifetz/column.app.216a26f4.f9568c2743d526501aea.css" rel="stylesheet"/><script defer="" crossorigin="anonymous" src="https://unpkg.zhimg.com/@cfe/sentry-script@latest/dist/init.js" data-sentry-config="{&quot;dsn&quot;:&quot;https://2d8d764432cc4f6fb3bc78ab9528299d@crash2.zhihu.com/1224&quot;,&quot;sampleRate&quot;:0.1,&quot;release&quot;:&quot;1202-292d138f&quot;,&quot;ignoreErrorNames&quot;:[&quot;NetworkError&quot;,&quot;SecurityError&quot;],&quot;ignoreErrors&quot;:[&quot;origin message&quot;,&quot;Network request failed&quot;,&quot;Loading chunk&quot;,&quot;这个系统不支持该功能。&quot;,&quot;Can&#x27;t find variable: webkit&quot;,&quot;Can&#x27;t find variable: $&quot;,&quot;内存不足&quot;,&quot;out of memory&quot;,&quot;DOM Exception 18&quot;,&quot;The operation is insecure&quot;,&quot;[object Event]&quot;,&quot;[object FileError]&quot;,&quot;[object DOMError]&quot;,&quot;[object Object]&quot;,&quot;拒绝访问。&quot;,&quot;Maximum call stack size exceeded&quot;,&quot;UploadError&quot;,&quot;无法 fetch&quot;,&quot;draft-js&quot;,&quot;缺少 JavaScript 对象&quot;,&quot;componentWillEnter&quot;,&quot;componentWillLeave&quot;,&quot;componentWillAppear&quot;,&quot;getInlineStyleAt&quot;,&quot;getCharacterList&quot;],&quot;whitelistUrls&quot;:[&quot;static.zhihu.com&quot;]}"></script></head><body class="WhiteBg-body"><div id="root"><div class="App"><div class="LoadingBar"></div><main role="main" class="App-main"><div class="Post-content" data-zop-usertoken="{&quot;userToken&quot;:&quot;&quot;}" data-zop="{&quot;authorName&quot;:&quot;黄兢成&quot;,&quot;itemId&quot;:95299255,&quot;title&quot;:&quot;C 接口中的内存分配释放&quot;,&quot;type&quot;:&quot;article&quot;}"><div class="ColumnPageHeader-Wrapper"><div><div class="Sticky ColumnPageHeader"><div class="ColumnPageHeader-content"><a class="ZhihuLogoLink" href="//www.zhihu.com" aria-label="知乎"><svg viewBox="0 0 200 91" fill="#0084FF" width="64" height="30"><path d="M53.29 80.035l7.32.002 2.41 8.24 13.128-8.24h15.477v-67.98H53.29v67.978zm7.79-60.598h22.756v53.22h-8.73l-8.718 5.473-1.587-5.46-3.72-.012v-53.22zM46.818 43.162h-16.35c.545-8.467.687-16.12.687-22.955h15.987s.615-7.05-2.68-6.97H16.807c1.09-4.1 2.46-8.332 4.1-12.708 0 0-7.523 0-10.085 6.74-1.06 2.78-4.128 13.48-9.592 24.41 1.84-.2 7.927-.37 11.512-6.94.66-1.84.785-2.08 1.605-4.54h9.02c0 3.28-.374 20.9-.526 22.95H6.51c-3.67 0-4.863 7.38-4.863 7.38H22.14C20.765 66.11 13.385 79.24 0 89.62c6.403 1.828 12.784-.29 15.937-3.094 0 0 7.182-6.53 11.12-21.64L43.92 85.18s2.473-8.402-.388-12.496c-2.37-2.788-8.768-10.33-11.496-13.064l-4.57 3.627c1.363-4.368 2.183-8.61 2.46-12.71H49.19s-.027-7.38-2.372-7.38zm128.752-.502c6.51-8.013 14.054-18.302 14.054-18.302s-5.827-4.625-8.556-1.27c-1.874 2.548-11.51 15.063-11.51 15.063l6.012 4.51zm-46.903-18.462c-2.814-2.577-8.096.667-8.096.667s12.35 17.2 12.85 17.953l6.08-4.29s-8.02-11.752-10.83-14.33zM199.99 46.5c-6.18 0-40.908.292-40.953.292v-31.56c1.503 0 3.882-.124 7.14-.376 12.773-.753 21.914-1.25 27.427-1.504 0 0 3.817-8.496-.185-10.45-.96-.37-7.24 1.43-7.24 1.43s-51.63 5.153-72.61 5.64c.5 2.756 2.38 5.336 4.93 6.11 4.16 1.087 7.09.53 15.36.277 7.76-.5 13.65-.76 17.66-.76v31.19h-41.71s.88 6.97 7.97 7.14h33.73v22.16c0 4.364-3.498 6.87-7.65 6.6-4.4.034-8.15-.36-13.027-.566.623 1.24 1.977 4.496 6.035 6.824 3.087 1.502 5.054 2.053 8.13 2.053 9.237 0 14.27-5.4 14.027-14.16V53.93h38.235c3.026 0 2.72-7.432 2.72-7.432z" fill-rule="evenodd"></path></svg></a><i class="ColumnPageHeader-Line"></i><div class="ColumnPageHeader-Title"><div class="ColumnPageHeader-TitleName"><span class="ColumnPageHeader-TitleMeta">首发于</span><a class="ColumnLink ColumnPageHeader-TitleColumn" href="//www.zhihu.com/column/hjcapple">黄二少碎碎念</a></div></div><div class="ColumnPageHeader-Button"><button type="button" class="Button ColumnPageHeader-WriteButton Button--blue"><svg class="Zi Zi--EditSurround" fill="currentColor" viewBox="0 0 24 24" width="24" height="24"><path d="M18.453 7.992l-1.833-1.65.964-.978a1.223 1.223 0 0 1 1.73-.012l.005.006a1.24 1.24 0 0 1 .007 1.748l-.873.886zm-1.178 1.194l-5.578 5.66-1.935.697a.393.393 0 0 1-.504-.504l.697-1.935 5.488-5.567 1.832 1.65zM7.58 5.848l5.654.006-1.539 1.991-3.666.012A1.02 1.02 0 0 0 7 8.868v7.993c0 .558.46 1.01 1.029 1.01l7.941-.01c.568 0 1.03-.453 1.03-1.012v-4.061l2-1.442v6.002c0 1.397-1.2 2.501-2.62 2.501H7.574C6.153 19.85 5 18.717 5 17.32V8.35c0-1.397 1.16-2.502 2.58-2.502z"></path></svg>写文章</button></div></div></div></div></div><article class="Post-Main Post-NormalMain" tabindex="-1"><header class="Post-Header"><h1 class="Post-Title">C 接口中的内存分配释放</h1><div class="Post-Author"><div class="AuthorInfo" itemProp="author" itemscope="" itemType="http://schema.org/Person"><meta itemProp="name" content="黄兢成"/><meta itemProp="image" content="https://pic1.zhimg.com/2447e1332_l.jpg?source=172ae18b"/><meta itemProp="url" content="https://www.zhihu.com/people/huang-jing-cheng"/><meta itemProp="zhihu:followerCount"/><span class="UserLink AuthorInfo-avatarWrapper"><a class="UserLink-link" data-za-detail-view-element_name="User" target="_blank" href="//www.zhihu.com/people/huang-jing-cheng"><img class="Avatar Avatar--round AuthorInfo-avatar" width="38" height="38" src="https://pic1.zhimg.com/2447e1332_xs.jpg?source=172ae18b" srcSet="https://pic1.zhimg.com/2447e1332_l.jpg?source=172ae18b 2x" alt="黄兢成"/></a></span><div class="AuthorInfo-content"><div class="AuthorInfo-head"><span class="UserLink AuthorInfo-name"><a class="UserLink-link" data-za-detail-view-element_name="User" target="_blank" href="//www.zhihu.com/people/huang-jing-cheng">黄兢成</a><style data-emotion-css="1cd9gw4">.css-1cd9gw4{margin-left:.3em;}</style><style data-emotion-css="n99yhz">.css-n99yhz{box-sizing:border-box;margin:0;min-width:0;color:#175199;display:inline-block;margin-left:.3em;}</style><a href="https://www.zhihu.com/topic/20054793" target="_blank" class="css-n99yhz" aria-label="编程话题下的优秀回答者" data-tooltip="编程话题下的优秀回答者"><style data-emotion-css="18biwo">.css-18biwo{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><span class="css-18biwo">​<style data-emotion-css="1ifz0go">.css-1ifz0go{overflow:visible!important;}</style><svg viewBox="0 0 24 24" class="css-1ifz0go" width="18" height="18"><svg viewBox="0 0 24 24" x="-3" y="-3" fill="#FFFFFF" width="30" height="30"><path d="M3.56231227,13.8535307 C2.40051305,12.768677 2.41398885,11.0669203 3.59484487,9.99979213 L3.59222085,9.99654885 C4.26730143,9.45036719 4.79446755,8.21005186 4.7184197,7.34453784 L4.72305873,7.34412719 C4.66942824,5.75539997 5.8824188,4.56066914 7.47188965,4.64242381 L7.47229112,4.6386236 C8.33515314,4.72977993 9.58467253,4.22534048 10.1426329,3.55925173 L10.1462611,3.56228565 C11.2316055,2.40008701 12.9353108,2.41394456 14.0015072,3.59634088 L14.0047263,3.59374004 C14.5498229,4.26841874 15.7896857,4.79521622 16.6545744,4.71844347 L16.6549836,4.72304294 C18.245027,4.66894057 19.4396947,5.88213996 19.3575031,7.47241135 L19.3623099,7.47292747 C19.2704388,8.3358681 19.7742711,9.58421483 20.4407199,10.1424506 L20.437686,10.1460789 C21.5997217,11.2312209 21.5860695,12.9345218 20.4042441,14.0007396 L20.4072865,14.0045125 C19.7325967,14.5495925 19.2055209,15.7896954 19.2815865,16.6561959 L19.2770449,16.6565978 C19.3315454,18.2453037 18.1173775,19.4393568 16.5274188,19.3571512 L16.5269029,19.3619539 C15.6647098,19.270083 14.415408,19.7741709 13.8573671,20.4403558 L13.8537409,20.4373235 C12.76842,21.5995708 11.0650432,21.5864553 9.99899434,20.4039226 L9.99527367,20.406923 C9.45025436,19.7323399 8.21017638,19.2051872 7.34461983,19.2812352 L7.344304,19.2776405 C5.75448683,19.3312904 4.55977145,18.1170085 4.64254978,16.527117 L4.63769921,16.5265942 C4.72957031,15.6644394 4.22547659,14.4151814 3.55928015,13.8571569 L3.56231227,13.8535307 Z"></path></svg><path d="M2.63951518,13.3895441 C3.70763333,14.2842292 4.44777637,16.1226061 4.30075305,17.5023312 L4.32211542,17.3063047 C4.17509209,18.6910561 5.17786655,19.7063729 6.5613937,19.5844846 L6.364106,19.6008202 C7.75140298,19.4789319 9.57474349,20.2554985 10.4468305,21.3349009 L10.3224262,21.1803415 C11.1982831,22.2647703 12.6257916,22.2723098 13.5167278,21.2079863 L13.3898102,21.3600325 C14.2845162,20.2919393 16.1229361,19.5518136 17.5026934,19.6988334 L17.3054057,19.6774716 C18.6914461,19.8244915 19.7067866,18.8217404 19.5836389,17.4395022 L19.6012314,17.6367853 C19.4793403,16.2482641 20.255925,14.4249662 21.3353526,13.5528995 L21.1807897,13.677301 C22.2639871,12.8014646 22.2727834,11.3739894 21.2084351,10.483074 L21.3604848,10.6099886 C20.2923667,9.71530351 19.5522236,7.87818322 19.6992469,6.49720154 L19.6778846,6.69448464 C19.8249079,5.30847665 18.8221335,4.2944164 17.4386063,4.41630468 L17.635894,4.39871256 C16.248597,4.52185742 14.4252565,3.74529084 13.5531695,2.66588842 L13.6775738,2.81919121 C12.8017169,1.73601905 11.3742084,1.72722299 10.4832722,2.79154644 L10.6101898,2.63950024 C9.71548377,3.70759343 7.87706394,4.44771919 6.49730661,4.30195588 L6.69459432,4.32206116 C5.30855394,4.17504128 4.29447,5.17904888 4.41636114,6.56128713 L4.3987686,6.36400404 C4.52065973,7.75126861 3.74407501,9.57456653 2.66464737,10.4478898 L2.81921035,10.3222318 C1.73601288,11.1993248 1.72721662,12.6255433 2.79156494,13.5164587 L2.63951518,13.3895441 Z" fill="#FF9607"></path><svg class="Zi Zi--Star" fill="#fff" x="6" y="6" viewBox="0 0 24 24" width="12" height="12"><path d="M5.515 19.64l.918-5.355-3.89-3.792c-.926-.902-.639-1.784.64-1.97L8.56 7.74l2.404-4.871c.572-1.16 1.5-1.16 2.072 0L15.44 7.74l5.377.782c1.28.186 1.566 1.068.64 1.97l-3.89 3.793.918 5.354c.219 1.274-.532 1.82-1.676 1.218L12 18.33l-4.808 2.528c-1.145.602-1.896.056-1.677-1.218z" fill-rule="evenodd"></path></svg></svg></span></a></span></div><div class="AuthorInfo-detail"><div class="AuthorInfo-badge"><div class="ztext AuthorInfo-badgeText">编程话题下的优秀回答者</div></div></div></div></div></div><div><span class="Voters"><button type="button" class="Button Button--plain">27 人<!-- -->赞同了该文章</button></span></div></header><div class="Post-RichTextContainer"><div class="RichText ztext Post-RichText"><p>写代码讲究职责分离，具体到内存，就是谁分配，谁负责释放。这个谁，根据不同的场合，可以是某个函数、某个类、某个组件。</p><p>但我们不讨论大而泛的原则，只讨论一个具体的 C 函数。比如路径拼接：</p><div class="highlight"><pre><code class="language-cpp"><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="nf">path_join</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">path0</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">path1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">xxxxxx</span><span class="p">;</span>        <span class="c1">// 计算 size
</span><span class="c1"></span>    <span class="kt">char</span><span class="o">*</span> <span class="n">result</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span> <span class="c1">// 分配动态内存
</span><span class="c1"></span>    <span class="c1">// 做某些事
</span><span class="c1"></span>    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>现在的问题是，path_join 返回的动态内存应该如何释放？</p><ol><li>如果是外面调用 path_join 的函数释放，似乎就违反了谁分配谁释放的原则。里面分配，外面释放，这种不对称调用很容易忘记，产生泄露。</li><li>如果是在 path_join 里面释放，函数返回后，外面得到的是野指针。</li></ol><p>这似乎是个两难问题。</p><p>这种问题可能是 C 特有的。Java 之类使用垃圾收集的语言，这问题不存在，里面只管 new 对象就行。C++ 可以返回一个智能指针，或者直接返回 <code>std::string</code> 等对象。</p><p>这种问题也很常见。各种语言相互交互，基本都会提供 C 接口。某些跨平台的库，经常是内部使用 C++ 实现，再对外提供 C 风格的接口，因为 C++ 没有二进制标准，跨库使用 C++ 接口有时会有奇奇怪怪的问题。</p><p>总会有一天，或者使用别人的 C 接口、或者自己设计 C 接口，就涉及到类似的分配释放。在 C 中，有多种方法，究竟哪种更好需要根据场合判断。</p><h3><b>知道最大值</b></h3><p>有时，在调用接口前就知道内存最大值。可以类似这样写：</p><div class="highlight"><pre><code class="language-cpp"><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="nf">getCurrentPath</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">bufsize</span><span class="p">);</span>

<span class="kt">char</span> <span class="n">path</span><span class="p">[</span><span class="n">MAX_PATH_SIZE</span><span class="p">];</span>
<span class="n">getCurrentPath</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">MAX_PATH_SIZE</span><span class="p">);</span>
</code></pre></div><p>在调用之前，已经预知路径的最大长度。传入 buf 和 bufsize, 函数内部对数据进行填充。这样根本就不需要动态分配 char*, 也就没有释放问题。注意这个最大值也不能过大，假如栈中直接定义 1M、2M 的内存，很容易就栈溢出。</p><p>C 字符串最后会填充一个 0。有时这种风格的接口，第二个参数并非 <code>bufsize</code>，而是字符串的最大长度 <code>max_str_len</code>。当同一个工程使用多个库时，它们的含义可能不同，很容易弄混。因而很多人会多添加一个字节。</p><div class="highlight"><pre><code class="language-cpp"><span class="kt">char</span> <span class="n">path</span><span class="p">[</span><span class="n">MAX_PATH_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
<span class="n">getCurrentPath</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">MAX_PATH_SIZE</span><span class="p">);</span>
</code></pre></div><p>这种接口可以返回错误码。假如根本不会发生错误，有时返回 <code>const char*</code>, 方便连锁调用，比如</p><div class="highlight"><pre><code class="language-cpp"><span class="kt">char</span> <span class="n">path</span><span class="p">[</span><span class="n">MAX_PATH_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
<span class="n">printf</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">getCurrentPath</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">MAX_PATH_SIZE</span><span class="p">));</span>
</code></pre></div><p>也可以将其封装成结构，比如</p><div class="highlight"><pre><code class="language-cpp"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">path</span><span class="p">[</span><span class="n">MAX_PATH_SIZE</span><span class="p">];</span>
    <span class="n">size_t</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span> <span class="n">Path</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">getCurrentPath</span><span class="p">(</span><span class="n">Path</span><span class="o">*</span> <span class="n">path</span><span class="p">);</span>

<span class="n">Path</span> <span class="n">path</span><span class="p">;</span>
<span class="n">getCurrentPath</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="p">);</span>
</code></pre></div><h3><b>不知道最大值</b></h3><p>不知道最大值时，就只能动态分配了。一种风格是让用户调用两次，比如</p><div class="highlight"><pre><code class="language-cpp"><span class="kt">int</span> <span class="nf">getTitle</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">getTitle</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="kt">char</span><span class="o">*</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">getTitle</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="n">xxx</span>
<span class="nf">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</code></pre></div><p>在调用之前，还不知道最终长度。于是用户先使用 NULL 调用一次 <code>getTitle(NULL, 0)</code>，返回需要的内存大小。之后根据大小动态分配内存，这时内存的分配和释放都交给了用户。这种风格挺常见的，通常需要两次调用。</p><p>这种风格，返回的 int 有多个含义，通常返回负数表示失败。</p><p>另一种可选的风格是，库内部临时管理内存，用户访问结果。假如要将结果保存下来以后使用，用户就自己分配内存拷贝。比如</p><div class="highlight"><pre><code class="language-cpp"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">result</span><span class="p">;</span>
    <span class="n">size_t</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span> <span class="n">Base64Context</span><span class="p">;</span>

<span class="n">Base64Context</span><span class="o">*</span> <span class="nf">base64_allocContext</span><span class="p">();</span>
<span class="kt">void</span> <span class="nf">base64_freeContext</span><span class="p">(</span><span class="n">Base64Context</span><span class="o">*</span> <span class="n">ctx</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">base64_decode</span><span class="p">(</span><span class="n">Base64Context</span><span class="o">*</span> <span class="n">ctx</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">size</span><span class="p">);</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="nf">base64_getResult</span><span class="p">(</span><span class="n">Base64Context</span><span class="o">*</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">size_t</span><span class="o">*</span> <span class="n">size</span><span class="p">);</span>

<span class="c1">////////////////////
</span><span class="c1"></span><span class="n">Base64Context</span><span class="o">*</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">base64_allocContext</span><span class="p">();</span>
<span class="n">base64_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">data1</span><span class="p">,</span> <span class="n">data1_size</span><span class="p">);</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">ret1</span> <span class="o">=</span> <span class="n">base64_getResult</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size1</span><span class="p">);</span>

<span class="n">xxxxx</span>

<span class="nf">base64_decode</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">data2</span><span class="p">,</span> <span class="n">data2_size</span><span class="p">);</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">ret2</span> <span class="o">=</span> <span class="n">base64_getResult</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size2</span><span class="p">);</span>

<span class="n">xxxx</span>

<span class="nf">base64_freeContext</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
</code></pre></div><p>这种风格中，会先有更高一层，类似 context 的东西, 在里面管理返回的 <code>char*</code>。每次 decode 的结果，都先放到库自己管理的内存中，之后调用 getResult 获取。于是同一个内存，可在多次 decode 中复用。每调用一次 decode, 会将之前的结果冲掉。在释放 context 的时候，再释放 <code>char*</code>。</p><p>假如嫌上面两种风格麻烦，还可以在接口中注明，让用户自己释放，比如：</p><div class="highlight"><pre><code class="language-cpp"><span class="c1">// 此函数的返回结果，需要调用 base64_free 释放。
</span><span class="c1"></span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="nf">base64_decode</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">size</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">base64_free</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">////////////
</span><span class="c1"></span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">base64_decode</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="n">xxxx</span>
<span class="nf">base64_free</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
</code></pre></div><p>这样调用够简单，但貌似违背了谁分配，谁释放的原则。但稍微变通一下，将原则理解成，谁用这函数谁释放，也是可以的。</p><p>特别注意，虽然 <code>base64_free</code> 中只调用了 free，但也特别提供 <code>base64_free</code> 这个函数。没有让用户写成</p><div class="highlight"><pre><code class="language-cpp"><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">base64_decode</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="n">xxxx</span>
<span class="nf">free</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
</code></pre></div><p>因为库可能会被预先编译，编译成动态或者静态库。编译时 malloc、free，跟用户代码中的 malloc、free 有可能不同。而 malloc、free 需要严格匹配。</p><p>用 base64_free 包装着 free, 放到库的 .c 中编译，这时的 free 就是库编译时的 free。但假如让用户自己调用 free，就是用户代码中的 free，有可能跟 base64 库中使用的 malloc 不匹配。</p><h3><b>最开始的问题</b></h3><p>最开始的 path_join 路径拼接问题，假如此函数只出现在工程内部，随便怎么折腾都行。其实假如在工程内部，很可能也不用 C 来写了，写起来多麻烦。假如是真实的路径库，对外提供 C 风格的接口，可能是这样子：</p><div class="highlight"><pre><code class="language-cpp"><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">Path</span> <span class="n">Path</span><span class="p">;</span>

<span class="c1">// 分配释放，跟 const char* 相互转换
</span><span class="c1"></span><span class="n">Path</span><span class="o">*</span> <span class="nf">path_copy</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">path</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">len</span><span class="p">);</span>
<span class="n">Path</span><span class="o">*</span> <span class="nf">path_create</span><span class="p">();</span>
<span class="kt">void</span> <span class="nf">path_release</span><span class="p">(</span><span class="n">Path</span><span class="o">*</span> <span class="n">path</span><span class="p">);</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="nf">path_getstring</span><span class="p">(</span><span class="n">Path</span><span class="o">*</span> <span class="n">path</span><span class="p">,</span> <span class="n">size_t</span><span class="o">*</span> <span class="n">len</span><span class="p">);</span>

<span class="c1">// 具体的函数
</span><span class="c1"></span><span class="kt">int</span> <span class="nf">path_join</span><span class="p">(</span><span class="k">const</span> <span class="n">Path</span><span class="o">*</span> <span class="n">p0</span><span class="p">,</span> <span class="k">const</span> <span class="n">Path</span><span class="o">*</span> <span class="n">p1</span><span class="p">,</span> <span class="n">Path</span><span class="o">*</span> <span class="n">ret</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">path_split</span><span class="p">(</span><span class="k">const</span> <span class="n">Path</span><span class="o">*</span> <span class="n">path</span><span class="p">,</span> <span class="n">Path</span><span class="o">*</span> <span class="n">base</span><span class="p">,</span> <span class="n">Path</span><span class="o">*</span> <span class="n">last</span><span class="p">);</span>
</code></pre></div><p>C 风格的接口，一旦涉及到内存管理，用起来其实挺麻烦的。但 C 接口够通用，比如容易绑定到多种脚本语言。有了 C 库，假如用在 C++ 中，通常还会再包装一下，包装成更容易使用的，比如：</p><div class="highlight"><pre><code class="language-cpp"><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">path_join_easy</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">p0</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">p1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Path</span><span class="o">*</span> <span class="n">path0</span> <span class="o">=</span> <span class="n">path_copy</span><span class="p">(</span><span class="n">p0</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">p0</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
    <span class="n">Path</span><span class="o">*</span> <span class="n">path1</span> <span class="o">=</span> <span class="n">path_copy</span><span class="p">(</span><span class="n">p1</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">p1</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
    <span class="n">Path</span><span class="o">*</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">path_create</span><span class="p">();</span>
    
    <span class="n">path_join</span><span class="p">(</span><span class="n">path0</span><span class="p">,</span> <span class="n">path1</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

    <span class="n">size_t</span> <span class="n">len</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">str</span> <span class="o">=</span> <span class="n">path_getstring</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">path</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
    
    <span class="n">path_release</span><span class="p">(</span><span class="n">path0</span><span class="p">);</span>
    <span class="n">path_release</span><span class="p">(</span><span class="n">path1</span><span class="p">);</span>
    <span class="n">path_release</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">path</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p></p></div></div><div class="ContentItem-time">发布于 2019-12-04</div><div class="Post-topicsAndReviewer"><div class="TopicList Post-Topics"><div class="Tag Topic"><span class="Tag-content"><a class="TopicLink" href="//www.zhihu.com/topic/19601705" target="_blank"><div class="Popover"><div id="null-toggle" aria-haspopup="true" aria-expanded="false" aria-owns="null-content">C / C++</div></div></a></span></div><div class="Tag Topic"><span class="Tag-content"><a class="TopicLink" href="//www.zhihu.com/topic/19579205" target="_blank"><div class="Popover"><div id="null-toggle" aria-haspopup="true" aria-expanded="false" aria-owns="null-content">内存管理</div></div></a></span></div></div></div><div><div class="Sticky RichContent-actions is-bottom"><div class="ContentItem-actions"><span><button aria-label="赞同 27 " type="button" class="Button VoteButton VoteButton--up"><span style="display:inline-flex;align-items:center">​<svg class="Zi Zi--TriangleUp VoteButton-TriangleUp" fill="currentColor" viewBox="0 0 24 24" width="10" height="10"><path d="M2 18.242c0-.326.088-.532.237-.896l7.98-13.203C10.572 3.57 11.086 3 12 3c.915 0 1.429.571 1.784 1.143l7.98 13.203c.15.364.236.57.236.896 0 1.386-.875 1.9-1.955 1.9H3.955c-1.08 0-1.955-.517-1.955-1.9z" fill-rule="evenodd"></path></svg></span>赞同 27</button><button aria-label="反对" type="button" class="Button VoteButton VoteButton--down"><span style="display:inline-flex;align-items:center">​<svg class="Zi Zi--TriangleDown" fill="currentColor" viewBox="0 0 24 24" width="10" height="10"><path d="M20.044 3H3.956C2.876 3 2 3.517 2 4.9c0 .326.087.533.236.896L10.216 19c.355.571.87 1.143 1.784 1.143s1.429-.572 1.784-1.143l7.98-13.204c.149-.363.236-.57.236-.896 0-1.386-.876-1.9-1.956-1.9z" fill-rule="evenodd"></path></svg></span></button></span><button type="button" class="Button BottomActions-CommentBtn Button--plain Button--withIcon Button--withLabel"><span style="display:inline-flex;align-items:center">​<svg class="Zi Zi--Comment Button-zi" fill="currentColor" viewBox="0 0 24 24" width="1.2em" height="1.2em"><path d="M10.241 19.313a.97.97 0 0 0-.77.2 7.908 7.908 0 0 1-3.772 1.482.409.409 0 0 1-.38-.637 5.825 5.825 0 0 0 1.11-2.237.605.605 0 0 0-.227-.59A7.935 7.935 0 0 1 3 11.25C3 6.7 7.03 3 12 3s9 3.7 9 8.25-4.373 9.108-10.759 8.063z" fill-rule="evenodd"></path></svg></span>2 条评论</button><div class="Popover ShareMenu"><div class="ShareMenu-toggler" id="null-toggle" aria-haspopup="true" aria-expanded="false" aria-owns="null-content"><button type="button" class="Button Button--plain Button--withIcon Button--withLabel"><span style="display:inline-flex;align-items:center">​<svg class="Zi Zi--Share Button-zi" fill="currentColor" viewBox="0 0 24 24" width="1.2em" height="1.2em"><path d="M2.931 7.89c-1.067.24-1.275 1.669-.318 2.207l5.277 2.908 8.168-4.776c.25-.127.477.198.273.39L9.05 14.66l.927 5.953c.18 1.084 1.593 1.376 2.182.456l9.644-15.242c.584-.892-.212-2.029-1.234-1.796L2.93 7.89z" fill-rule="evenodd"></path></svg></span>分享</button></div></div><button type="button" class="Button ContentItem-action Button--plain Button--withIcon Button--withLabel"><span style="display:inline-flex;align-items:center">​<svg class="Zi Zi--Heart Button-zi" fill="currentColor" viewBox="0 0 24 24" width="1.2em" height="1.2em"><path d="M2 8.437C2 5.505 4.294 3.094 7.207 3 9.243 3 11.092 4.19 12 6c.823-1.758 2.649-3 4.651-3C19.545 3 22 5.507 22 8.432 22 16.24 13.842 21 12 21 10.158 21 2 16.24 2 8.437z" fill-rule="evenodd"></path></svg></span>喜欢</button><button type="button" class="Button ContentItem-action Button--plain Button--withIcon Button--withLabel"><span style="display:inline-flex;align-items:center">​<svg class="Zi Zi--Star Button-zi" fill="currentColor" viewBox="0 0 24 24" width="1.2em" height="1.2em"><path d="M5.515 19.64l.918-5.355-3.89-3.792c-.926-.902-.639-1.784.64-1.97L8.56 7.74l2.404-4.871c.572-1.16 1.5-1.16 2.072 0L15.44 7.74l5.377.782c1.28.186 1.566 1.068.64 1.97l-3.89 3.793.918 5.354c.219 1.274-.532 1.82-1.676 1.218L12 18.33l-4.808 2.528c-1.145.602-1.896.056-1.677-1.218z" fill-rule="evenodd"></path></svg></span>收藏</button><div class="Post-ActionMenuButton"><div class="Popover"><div id="null-toggle" aria-haspopup="true" aria-expanded="false" aria-owns="null-content"><button type="button" class="Button Button--plain Button--withIcon Button--iconOnly"><span style="display:inline-flex;align-items:center">​<svg class="Zi Zi--Dots Button-zi" fill="currentColor" viewBox="0 0 24 24" width="1.2em" height="1.2em"><path d="M5 14a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm7 0a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm7 0a2 2 0 1 1 0-4 2 2 0 0 1 0 4z" fill-rule="evenodd"></path></svg></span></button></div></div></div></div></div></div></article><div class="Post-Sub Post-NormalSub"><div class="PostIndex-Contributions"><h3 class="BlockTitle">文章被以下专栏收录</h3><ul><div class="ContentItem Column-ColumnItem"><div class="ContentItem-main"><div class="ContentItem-image"><a class="ColumnLink" href="//www.zhihu.com/column/hjcapple"><div class="Popover"><div id="null-toggle" aria-haspopup="true" aria-expanded="false" aria-owns="null-content"><img class="Avatar Avatar--medium Avatar--round" width="40" height="40" src="https://pic4.zhimg.com/02aa7a5bb0cd52f91f4deed1c5066d68_xs.jpg?source=172ae18b" srcSet="https://pic4.zhimg.com/02aa7a5bb0cd52f91f4deed1c5066d68_l.jpg?source=172ae18b 2x" alt="黄二少碎碎念"/></div></div></a></div><div class="ContentItem-head"><h2 class="ContentItem-title"><a class="ColumnLink ColumnItem-Title" href="//www.zhihu.com/column/hjcapple"><div class="Popover"><div id="null-toggle" aria-haspopup="true" aria-expanded="false" aria-owns="null-content">黄二少碎碎念</div></div></a></h2></div><div class="ContentItem-extra"><a href="//www.zhihu.com/column/hjcapple" type="button" class="Button">进入专栏</a></div></div></div></ul></div></div></div></main></div></div><script id="js-clientConfig" type="text/json">{"host":"zhihu.com","protocol":"https:","wwwHost":"www.zhihu.com","fetchRoot":{"www":"https:\u002F\u002Fwww.zhihu.com","api":"https:\u002F\u002Fapi.zhihu.com","zhuanlan":"https:\u002F\u002Fzhuanlan.zhihu.com"}}</script><script id="js-initialData" type="text/json">{"initialState":{"common":{"ask":{}},"loading":{"global":{"count":0},"local":{"env\u002FgetIpinfo\u002F":false,"article\u002Fget\u002F":false,"brand\u002FgetUrl\u002F":false}},"club":{"tags":{},"admins":{"data":[]},"members":{"data":[]},"explore":{"candidateSyncClubs":{}},"profile":{},"checkin":{},"comments":{"paging":{},"loading":{},"meta":{},"ids":{}},"postList":{"paging":{},"loading":{},"ids":{}},"recommend":{"data":[]},"silences":{"data":[]},"application":{"profile":null}},"entities":{"users":{"huang-jing-cheng":{"isFollowed":false,"avatarUrlTemplate":"https:\u002F\u002Fpic1.zhimg.com\u002F2447e1332.jpg?source=172ae18b","uid":"27249038327808","userType":"people","isFollowing":false,"urlToken":"huang-jing-cheng","id":"624dfc9564dbd296cb81c515c2fb6ae2","description":"【GitHub】 https:\u002F\u002Fgithub.com\u002Fhjcapple","name":"黄兢成","isAdvertiser":false,"headline":"iOS \u002F Mac \u002F C++ 开发者","gender":1,"url":"\u002Fpeople\u002F624dfc9564dbd296cb81c515c2fb6ae2","avatarUrl":"https:\u002F\u002Fpic1.zhimg.com\u002F2447e1332_l.jpg?source=172ae18b","isOrg":false,"type":"people","levelInfo":{"exp":83540,"level":7,"nicknameColor":{"color":"","nightModeColor":""},"levelIcon":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-925f3f81dab3105fd42b785305a1cc28_l.png","iconInfo":{"url":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-925f3f81dab3105fd42b785305a1cc28_l.png","nightModeUrl":"https:\u002F\u002Fpic4.zhimg.com\u002Fv2-4e20c1d51a61ffb91eebdc40e420e382_l.png","width":93,"height":51}},"badge":[{"type":"best_answerer","topics":[{"url":"https:\u002F\u002Fwww.zhihu.com\u002Ftopic\u002F19554298","type":"topic","id":"19554298","name":"编程"},{"url":"https:\u002F\u002Fwww.zhihu.com\u002Ftopic\u002F19555404","type":"topic","id":"19555404","name":"iOS 开发"}],"description":"优秀回答者"}],"badgeV2":{"title":"编程话题下的优秀回答者","mergedBadges":[{"type":"best","detailType":"best","title":"优秀认证","description":"编程话题下的优秀回答者","url":"https:\u002F\u002Fwww.zhihu.com\u002Ftopic\u002F20054793","sources":[{"id":"19554298","token":"19554298","type":"topic","url":"https:\u002F\u002Fwww.zhihu.com\u002Ftopic\u002F19554298","name":"编程","avatarPath":"v2-27b8ba1e647956fa6f1a2a8ad90138ef","avatarUrl":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-27b8ba1e647956fa6f1a2a8ad90138ef_hd.jpg","description":"","priority":0},{"id":"19555404","token":"19555404","type":"topic","url":"https:\u002F\u002Fwww.zhihu.com\u002Ftopic\u002F19555404","name":"iOS 开发","avatarPath":"v2-4764fda08ea8e68c231a9223a670bd3b.png","avatarUrl":"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-4764fda08ea8e68c231a9223a670bd3b_hd.jpg","description":"","priority":0}],"icon":"","nightIcon":""}],"detailBadges":[{"type":"best","detailType":"best_answerer","title":"优秀回答者","description":"编程话题下的优秀回答者","url":"https:\u002F\u002Fwww.zhihu.com\u002Ftopic\u002F20054793","sources":[{"id":"19554298","token":"19554298","type":"topic","url":"https:\u002F\u002Fwww.zhihu.com\u002Ftopic\u002F19554298","name":"编程","avatarPath":"v2-27b8ba1e647956fa6f1a2a8ad90138ef","avatarUrl":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-27b8ba1e647956fa6f1a2a8ad90138ef_hd.jpg","description":"","priority":0},{"id":"19555404","token":"19555404","type":"topic","url":"https:\u002F\u002Fwww.zhihu.com\u002Ftopic\u002F19555404","name":"iOS 开发","avatarPath":"v2-4764fda08ea8e68c231a9223a670bd3b.png","avatarUrl":"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-4764fda08ea8e68c231a9223a670bd3b_hd.jpg","description":"","priority":0}],"icon":"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-bf0eec3c31c8e866c468f60eb296696c_l.png","nightIcon":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-c724649168d8f9d36d7c3d13140a2594_l.png"}],"icon":"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-bf0eec3c31c8e866c468f60eb296696c_l.png","nightIcon":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-c724649168d8f9d36d7c3d13140a2594_l.png"},"exposedMedal":{"medalId":"1124316222665379841","medalName":"我的知乎 2019","avatarUrl":"https:\u002F\u002Fpic2.zhimg.com\u002Fv2-2592b0b52e1fac99f69b38e00252413b_r.png?source=172ae18b","miniAvatarUrl":"https:\u002F\u002Fpic4.zhimg.com\u002Fv2-ad363cc3088dc8de7544fd08b1c4987a_l.png?source=172ae18b","description":"参与「我的知乎 2019」即可获得"}}},"questions":{},"answers":{},"articles":{"95299255":{"trackUrl":["https:\u002F\u002Fsugar.zhihu.com\u002Fplutus_adreaper\u002Fpage_monitor_log?si=__SESSIONID__&ti=__ATOKEN__&at=view&pf=__OS__&ed=__MEMBERID__&idfa=__IDFA__&imei=__IMEI__&androidid=__ANDROIDID__&oaid=__OAID__&ci=__CREATIVEID__&zid=__ZONEID__"],"id":95299255,"title":"C 接口中的内存分配释放","type":"article","articleType":"normal","excerptTitle":"","url":"https:\u002F\u002Fzhuanlan.zhihu.com\u002Fp\u002F95299255","imageUrl":"","titleImage":"","excerpt":"写代码讲究职责分离，具体到内存，就是谁分配，谁负责释放。这个谁，根据不同的场合，可以是某个函数、某个类、某个组件。 但我们不讨论大而泛的原则，只讨论一个具体的 C 函数。比如路径拼接： const char* path_join(const char* path0, const char* path…","created":1575450219,"updated":1575450219,"author":{"isFollowed":false,"avatarUrlTemplate":"https:\u002F\u002Fpic1.zhimg.com\u002F2447e1332.jpg?source=172ae18b","uid":"27249038327808","userType":"people","isFollowing":false,"urlToken":"huang-jing-cheng","id":"624dfc9564dbd296cb81c515c2fb6ae2","description":"【GitHub】 https:\u002F\u002Fgithub.com\u002Fhjcapple","name":"黄兢成","isAdvertiser":false,"headline":"iOS \u002F Mac \u002F C++ 开发者","gender":1,"url":"\u002Fpeople\u002F624dfc9564dbd296cb81c515c2fb6ae2","avatarUrl":"https:\u002F\u002Fpic1.zhimg.com\u002F2447e1332_l.jpg?source=172ae18b","isOrg":false,"type":"people","levelInfo":{"exp":83540,"level":7,"nicknameColor":{"color":"","nightModeColor":""},"levelIcon":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-925f3f81dab3105fd42b785305a1cc28_l.png","iconInfo":{"url":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-925f3f81dab3105fd42b785305a1cc28_l.png","nightModeUrl":"https:\u002F\u002Fpic4.zhimg.com\u002Fv2-4e20c1d51a61ffb91eebdc40e420e382_l.png","width":93,"height":51}},"badge":[{"type":"best_answerer","topics":[{"url":"https:\u002F\u002Fwww.zhihu.com\u002Ftopic\u002F19554298","type":"topic","id":"19554298","name":"编程"},{"url":"https:\u002F\u002Fwww.zhihu.com\u002Ftopic\u002F19555404","type":"topic","id":"19555404","name":"iOS 开发"}],"description":"优秀回答者"}],"badgeV2":{"title":"编程话题下的优秀回答者","mergedBadges":[{"type":"best","detailType":"best","title":"优秀认证","description":"编程话题下的优秀回答者","url":"https:\u002F\u002Fwww.zhihu.com\u002Ftopic\u002F20054793","sources":[{"id":"19554298","token":"19554298","type":"topic","url":"https:\u002F\u002Fwww.zhihu.com\u002Ftopic\u002F19554298","name":"编程","avatarPath":"v2-27b8ba1e647956fa6f1a2a8ad90138ef","avatarUrl":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-27b8ba1e647956fa6f1a2a8ad90138ef_hd.jpg","description":"","priority":0},{"id":"19555404","token":"19555404","type":"topic","url":"https:\u002F\u002Fwww.zhihu.com\u002Ftopic\u002F19555404","name":"iOS 开发","avatarPath":"v2-4764fda08ea8e68c231a9223a670bd3b.png","avatarUrl":"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-4764fda08ea8e68c231a9223a670bd3b_hd.jpg","description":"","priority":0}],"icon":"","nightIcon":""}],"detailBadges":[{"type":"best","detailType":"best_answerer","title":"优秀回答者","description":"编程话题下的优秀回答者","url":"https:\u002F\u002Fwww.zhihu.com\u002Ftopic\u002F20054793","sources":[{"id":"19554298","token":"19554298","type":"topic","url":"https:\u002F\u002Fwww.zhihu.com\u002Ftopic\u002F19554298","name":"编程","avatarPath":"v2-27b8ba1e647956fa6f1a2a8ad90138ef","avatarUrl":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-27b8ba1e647956fa6f1a2a8ad90138ef_hd.jpg","description":"","priority":0},{"id":"19555404","token":"19555404","type":"topic","url":"https:\u002F\u002Fwww.zhihu.com\u002Ftopic\u002F19555404","name":"iOS 开发","avatarPath":"v2-4764fda08ea8e68c231a9223a670bd3b.png","avatarUrl":"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-4764fda08ea8e68c231a9223a670bd3b_hd.jpg","description":"","priority":0}],"icon":"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-bf0eec3c31c8e866c468f60eb296696c_l.png","nightIcon":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-c724649168d8f9d36d7c3d13140a2594_l.png"}],"icon":"https:\u002F\u002Fpic3.zhimg.com\u002Fv2-bf0eec3c31c8e866c468f60eb296696c_l.png","nightIcon":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-c724649168d8f9d36d7c3d13140a2594_l.png"},"exposedMedal":{"medalId":"1124316222665379841","medalName":"我的知乎 2019","avatarUrl":"https:\u002F\u002Fpic2.zhimg.com\u002Fv2-2592b0b52e1fac99f69b38e00252413b_r.png?source=172ae18b","miniAvatarUrl":"https:\u002F\u002Fpic4.zhimg.com\u002Fv2-ad363cc3088dc8de7544fd08b1c4987a_l.png?source=172ae18b","description":"参与「我的知乎 2019」即可获得"}},"commentPermission":"all","copyrightPermission":"need_review","state":"published","imageWidth":0,"imageHeight":0,"content":"\u003Cp\u003E写代码讲究职责分离，具体到内存，就是谁分配，谁负责释放。这个谁，根据不同的场合，可以是某个函数、某个类、某个组件。\u003C\u002Fp\u003E\u003Cp\u003E但我们不讨论大而泛的原则，只讨论一个具体的 C 函数。比如路径拼接：\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-cpp\"\u003E\u003Cspan class=\"k\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Echar\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Epath_join\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"k\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Echar\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Epath0\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Echar\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Epath1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003Esize_t\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Esize\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Exxxxxx\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E        \u003Cspan class=\"c1\"\u003E\u002F\u002F 计算 size\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E    \u003Cspan class=\"kt\"\u003Echar\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eresult\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Emalloc\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Esize\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E \u003Cspan class=\"c1\"\u003E\u002F\u002F 分配动态内存\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E    \u003Cspan class=\"c1\"\u003E\u002F\u002F 做某些事\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E    \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eresult\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003E现在的问题是，path_join 返回的动态内存应该如何释放？\u003C\u002Fp\u003E\u003Col\u003E\u003Cli\u003E如果是外面调用 path_join 的函数释放，似乎就违反了谁分配谁释放的原则。里面分配，外面释放，这种不对称调用很容易忘记，产生泄露。\u003C\u002Fli\u003E\u003Cli\u003E如果是在 path_join 里面释放，函数返回后，外面得到的是野指针。\u003C\u002Fli\u003E\u003C\u002Fol\u003E\u003Cp\u003E这似乎是个两难问题。\u003C\u002Fp\u003E\u003Cp\u003E这种问题可能是 C 特有的。Java 之类使用垃圾收集的语言，这问题不存在，里面只管 new 对象就行。C++ 可以返回一个智能指针，或者直接返回 \u003Ccode\u003Estd::string\u003C\u002Fcode\u003E 等对象。\u003C\u002Fp\u003E\u003Cp\u003E这种问题也很常见。各种语言相互交互，基本都会提供 C 接口。某些跨平台的库，经常是内部使用 C++ 实现，再对外提供 C 风格的接口，因为 C++ 没有二进制标准，跨库使用 C++ 接口有时会有奇奇怪怪的问题。\u003C\u002Fp\u003E\u003Cp\u003E总会有一天，或者使用别人的 C 接口、或者自己设计 C 接口，就涉及到类似的分配释放。在 C 中，有多种方法，究竟哪种更好需要根据场合判断。\u003C\u002Fp\u003E\u003Ch3\u003E\u003Cb\u003E知道最大值\u003C\u002Fb\u003E\u003C\u002Fh3\u003E\u003Cp\u003E有时，在调用接口前就知道内存最大值。可以类似这样写：\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-cpp\"\u003E\u003Cspan class=\"k\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Echar\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EgetCurrentPath\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"kt\"\u003Echar\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Esize_t\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebufsize\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"kt\"\u003Echar\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Epath\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EMAX_PATH_SIZE\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E];\u003C\u002Fspan\u003E\n\u003Cspan class=\"n\"\u003EgetCurrentPath\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Epath\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EMAX_PATH_SIZE\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003E在调用之前，已经预知路径的最大长度。传入 buf 和 bufsize, 函数内部对数据进行填充。这样根本就不需要动态分配 char*, 也就没有释放问题。注意这个最大值也不能过大，假如栈中直接定义 1M、2M 的内存，很容易就栈溢出。\u003C\u002Fp\u003E\u003Cp\u003EC 字符串最后会填充一个 0。有时这种风格的接口，第二个参数并非 \u003Ccode\u003Ebufsize\u003C\u002Fcode\u003E，而是字符串的最大长度 \u003Ccode\u003Emax_str_len\u003C\u002Fcode\u003E。当同一个工程使用多个库时，它们的含义可能不同，很容易弄混。因而很多人会多添加一个字节。\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-cpp\"\u003E\u003Cspan class=\"kt\"\u003Echar\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Epath\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EMAX_PATH_SIZE\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"mi\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E];\u003C\u002Fspan\u003E\n\u003Cspan class=\"n\"\u003EgetCurrentPath\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Epath\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EMAX_PATH_SIZE\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003E这种接口可以返回错误码。假如根本不会发生错误，有时返回 \u003Ccode\u003Econst char*\u003C\u002Fcode\u003E, 方便连锁调用，比如\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-cpp\"\u003E\u003Cspan class=\"kt\"\u003Echar\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Epath\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EMAX_PATH_SIZE\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"mi\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E];\u003C\u002Fspan\u003E\n\u003Cspan class=\"n\"\u003Eprintf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;%s\u003C\u002Fspan\u003E\u003Cspan class=\"se\"\u003E\\n\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EgetCurrentPath\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Epath\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EMAX_PATH_SIZE\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E));\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003E也可以将其封装成结构，比如\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-cpp\"\u003E\u003Cspan class=\"k\"\u003Etypedef\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Estruct\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kt\"\u003Echar\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Epath\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EMAX_PATH_SIZE\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E];\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003Esize_t\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Esize\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EPath\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EgetCurrentPath\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EPath\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Epath\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"n\"\u003EPath\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Epath\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n\u003Cspan class=\"n\"\u003EgetCurrentPath\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&amp;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Epath\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Ch3\u003E\u003Cb\u003E不知道最大值\u003C\u002Fb\u003E\u003C\u002Fh3\u003E\u003Cp\u003E不知道最大值时，就只能动态分配了。一种风格是让用户调用两次，比如\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-cpp\"\u003E\u003Cspan class=\"kt\"\u003Eint\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003EgetTitle\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"kt\"\u003Echar\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Eint\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Elen\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"kt\"\u003Eint\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Elen\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EgetTitle\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"nb\"\u003ENULL\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"mi\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\u003Cspan class=\"kt\"\u003Echar\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Emalloc\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Elen\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E+\u003C\u002Fspan\u003E \u003Cspan class=\"mi\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\u003Cspan class=\"n\"\u003EgetTitle\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Elen\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\u003Cspan class=\"n\"\u003Exxx\u003C\u002Fspan\u003E\n\u003Cspan class=\"nf\"\u003Efree\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003E在调用之前，还不知道最终长度。于是用户先使用 NULL 调用一次 \u003Ccode\u003EgetTitle(NULL, 0)\u003C\u002Fcode\u003E，返回需要的内存大小。之后根据大小动态分配内存，这时内存的分配和释放都交给了用户。这种风格挺常见的，通常需要两次调用。\u003C\u002Fp\u003E\u003Cp\u003E这种风格，返回的 int 有多个含义，通常返回负数表示失败。\u003C\u002Fp\u003E\u003Cp\u003E另一种可选的风格是，库内部临时管理内存，用户访问结果。假如要将结果保存下来以后使用，用户就自己分配内存拷贝。比如\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-cpp\"\u003E\u003Cspan class=\"k\"\u003Etypedef\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Estruct\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"kt\"\u003Echar\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eresult\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003Esize_t\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Esize\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EBase64Context\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"n\"\u003EBase64Context\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Ebase64_allocContext\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E();\u003C\u002Fspan\u003E\n\u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Ebase64_freeContext\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EBase64Context\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ectx\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"kt\"\u003Eint\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Ebase64_decode\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EBase64Context\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ectx\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Echar\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Edata\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Esize_t\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Esize\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\u003Cspan class=\"k\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Echar\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Ebase64_getResult\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EBase64Context\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ectx\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Esize_t\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Esize\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"c1\"\u003E\u002F\u002F\u002F\u002F\u002F\u002F\u002F\u002F\u002F\u002F\u002F\u002F\u002F\u002F\u002F\u002F\u002F\u002F\u002F\u002F\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EBase64Context\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ectx\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebase64_allocContext\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E();\u003C\u002Fspan\u003E\n\u003Cspan class=\"n\"\u003Ebase64_decode\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ectx\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Edata1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Edata1_size\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\u003Cspan class=\"k\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Echar\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eret1\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebase64_getResult\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ectx\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E&amp;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Esize1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"n\"\u003Exxxxx\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"nf\"\u003Ebase64_decode\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ectx\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Edata2\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Edata2_size\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\u003Cspan class=\"k\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Echar\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eret2\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebase64_getResult\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ectx\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E&amp;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Esize2\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"n\"\u003Exxxx\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"nf\"\u003Ebase64_freeContext\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ectx\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003E这种风格中，会先有更高一层，类似 context 的东西, 在里面管理返回的 \u003Ccode\u003Echar*\u003C\u002Fcode\u003E。每次 decode 的结果，都先放到库自己管理的内存中，之后调用 getResult 获取。于是同一个内存，可在多次 decode 中复用。每调用一次 decode, 会将之前的结果冲掉。在释放 context 的时候，再释放 \u003Ccode\u003Echar*\u003C\u002Fcode\u003E。\u003C\u002Fp\u003E\u003Cp\u003E假如嫌上面两种风格麻烦，还可以在接口中注明，让用户自己释放，比如：\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-cpp\"\u003E\u003Cspan class=\"c1\"\u003E\u002F\u002F 此函数的返回结果，需要调用 base64_free 释放。\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"k\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Echar\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Ebase64_decode\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"k\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Echar\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Edata\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Esize_t\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Esize\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Ebase64_free\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ep\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003Efree\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ep\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"c1\"\u003E\u002F\u002F\u002F\u002F\u002F\u002F\u002F\u002F\u002F\u002F\u002F\u002F\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E\n\u003Cspan class=\"k\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Echar\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eret\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebase64_decode\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Edata\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Esize\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\u003Cspan class=\"n\"\u003Exxxx\u003C\u002Fspan\u003E\n\u003Cspan class=\"nf\"\u003Ebase64_free\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eret\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003E这样调用够简单，但貌似违背了谁分配，谁释放的原则。但稍微变通一下，将原则理解成，谁用这函数谁释放，也是可以的。\u003C\u002Fp\u003E\u003Cp\u003E特别注意，虽然 \u003Ccode\u003Ebase64_free\u003C\u002Fcode\u003E 中只调用了 free，但也特别提供 \u003Ccode\u003Ebase64_free\u003C\u002Fcode\u003E 这个函数。没有让用户写成\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-cpp\"\u003E\u003Cspan class=\"k\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Echar\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eret\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebase64_decode\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Edata\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Esize\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\u003Cspan class=\"n\"\u003Exxxx\u003C\u002Fspan\u003E\n\u003Cspan class=\"nf\"\u003Efree\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eret\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003E因为库可能会被预先编译，编译成动态或者静态库。编译时 malloc、free，跟用户代码中的 malloc、free 有可能不同。而 malloc、free 需要严格匹配。\u003C\u002Fp\u003E\u003Cp\u003E用 base64_free 包装着 free, 放到库的 .c 中编译，这时的 free 就是库编译时的 free。但假如让用户自己调用 free，就是用户代码中的 free，有可能跟 base64 库中使用的 malloc 不匹配。\u003C\u002Fp\u003E\u003Ch3\u003E\u003Cb\u003E最开始的问题\u003C\u002Fb\u003E\u003C\u002Fh3\u003E\u003Cp\u003E最开始的 path_join 路径拼接问题，假如此函数只出现在工程内部，随便怎么折腾都行。其实假如在工程内部，很可能也不用 C 来写了，写起来多麻烦。假如是真实的路径库，对外提供 C 风格的接口，可能是这样子：\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-cpp\"\u003E\u003Cspan class=\"k\"\u003Etypedef\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Estruct\u003C\u002Fspan\u003E \u003Cspan class=\"nc\"\u003EPath\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EPath\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"c1\"\u003E\u002F\u002F 分配释放，跟 const char* 相互转换\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EPath\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Epath_copy\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"k\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Echar\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Epath\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Esize_t\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Elen\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\u003Cspan class=\"n\"\u003EPath\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Epath_create\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E();\u003C\u002Fspan\u003E\n\u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Epath_release\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EPath\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Epath\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\u003Cspan class=\"k\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Echar\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Epath_getstring\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EPath\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Epath\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Esize_t\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Elen\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"c1\"\u003E\u002F\u002F 具体的函数\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"kt\"\u003Eint\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Epath_join\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"k\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EPath\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ep0\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EPath\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ep1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EPath\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eret\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\u003Cspan class=\"kt\"\u003Eint\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Epath_split\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"k\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EPath\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Epath\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EPath\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebase\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EPath\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Elast\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003EC 风格的接口，一旦涉及到内存管理，用起来其实挺麻烦的。但 C 接口够通用，比如容易绑定到多种脚本语言。有了 C 库，假如用在 C++ 中，通常还会再包装一下，包装成更容易使用的，比如：\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-cpp\"\u003E\u003Cspan class=\"n\"\u003Estd\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Estring\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Epath_join_easy\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"k\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Estd\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Estring\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&amp;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ep0\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Estd\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Estring\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&amp;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ep1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003EPath\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Epath0\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Epath_copy\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ep0\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ec_str\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(),\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ep0\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Esize\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E());\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003EPath\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Epath1\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Epath_copy\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ep1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ec_str\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(),\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ep1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Esize\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E());\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003EPath\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eret\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Epath_create\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E();\u003C\u002Fspan\u003E\n    \n    \u003Cspan class=\"n\"\u003Epath_join\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Epath0\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Epath1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eret\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"n\"\u003Esize_t\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Elen\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"k\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Echar\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E*\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Estr\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Epath_getstring\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eret\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E&amp;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Elen\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003Estd\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Estring\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Epath\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Estr\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Elen\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n    \n    \u003Cspan class=\"n\"\u003Epath_release\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Epath0\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003Epath_release\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Epath1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003Epath_release\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eret\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n    \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Epath\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp\u003E\u003C\u002Fp\u003E","adminClosedComment":false,"topics":[{"url":"https:\u002F\u002Fwww.zhihu.com\u002Fapi\u002Fv4\u002Ftopics\u002F19601705","type":"topic","id":"19601705","name":"C \u002F C++"},{"url":"https:\u002F\u002Fwww.zhihu.com\u002Fapi\u002Fv4\u002Ftopics\u002F19579205","type":"topic","id":"19579205","name":"内存管理"}],"voteupCount":27,"voting":0,"column":{"description":"","canManage":false,"intro":"","isFollowing":false,"urlToken":"hjcapple","id":"hjcapple","articlesCount":79,"acceptSubmission":true,"title":"黄二少碎碎念","url":"https:\u002F\u002Fzhuanlan.zhihu.com\u002Fhjcapple","commentPermission":"all","created":1439819496,"updated":1590871586,"imageUrl":"https:\u002F\u002Fpic4.zhimg.com\u002F02aa7a5bb0cd52f91f4deed1c5066d68_720w.jpg?source=172ae18b","author":{"isFollowed":false,"avatarUrlTemplate":"https:\u002F\u002Fpic2.zhimg.com\u002F2447e1332.jpg?source=172ae18b","uid":"27249038327808","userType":"people","isFollowing":false,"urlToken":"huang-jing-cheng","id":"624dfc9564dbd296cb81c515c2fb6ae2","description":"【GitHub】 https:\u002F\u002Fgithub.com\u002Fhjcapple","name":"黄兢成","isAdvertiser":false,"headline":"iOS \u002F Mac \u002F C++ 开发者","gender":1,"url":"\u002Fpeople\u002F624dfc9564dbd296cb81c515c2fb6ae2","avatarUrl":"https:\u002F\u002Fpic2.zhimg.com\u002F2447e1332_l.jpg?source=172ae18b","isOrg":false,"type":"people"},"followers":872,"type":"column"},"commentCount":2,"contributions":[{"id":22427687,"state":"accepted","type":"first_publish","column":{"description":"","canManage":false,"intro":"","isFollowing":false,"urlToken":"hjcapple","id":"hjcapple","articlesCount":79,"acceptSubmission":true,"title":"黄二少碎碎念","url":"https:\u002F\u002Fzhuanlan.zhihu.com\u002Fhjcapple","commentPermission":"all","created":1439819496,"updated":1590871586,"imageUrl":"https:\u002F\u002Fpic4.zhimg.com\u002F02aa7a5bb0cd52f91f4deed1c5066d68_720w.jpg?source=172ae18b","author":{"isFollowed":false,"avatarUrlTemplate":"https:\u002F\u002Fpic2.zhimg.com\u002F2447e1332.jpg?source=172ae18b","uid":"27249038327808","userType":"people","isFollowing":false,"urlToken":"huang-jing-cheng","id":"624dfc9564dbd296cb81c515c2fb6ae2","description":"【GitHub】 https:\u002F\u002Fgithub.com\u002Fhjcapple","name":"黄兢成","isAdvertiser":false,"headline":"iOS \u002F Mac \u002F C++ 开发者","gender":1,"url":"\u002Fpeople\u002F624dfc9564dbd296cb81c515c2fb6ae2","avatarUrl":"https:\u002F\u002Fpic2.zhimg.com\u002F2447e1332_l.jpg?source=172ae18b","isOrg":false,"type":"people"},"followers":872,"type":"column"}}],"isTitleImageFullScreen":false,"upvotedFollowees":[],"commercialInfo":{"isCommercial":false,"plugin":{}},"suggestEdit":{"status":false,"reason":"","tip":"","url":"","title":""},"reason":"","annotationAction":[],"canTip":false,"tipjarorsCount":0,"isLabeled":false,"hasPublishingDraft":false,"isFavorited":false,"isNormal":true,"status":0,"shareText":"C 接口中的内存分配释放 - 来自知乎专栏「黄二少碎碎念」，作者: 黄兢成 https:\u002F\u002Fzhuanlan.zhihu.com\u002Fp\u002F95299255 （想看更多？下载 @知乎 App：http:\u002F\u002Fweibo.com\u002Fp\u002F100404711598 ）","canComment":{"status":true,"reason":""},"mcnFpShow":-1,"isVisible":true,"isLiked":false,"likedCount":0,"visibleOnlyToAuthor":false,"hasColumn":true,"republishers":[]}},"columns":{"hjcapple":{"description":"","canManage":false,"intro":"","isFollowing":false,"urlToken":"hjcapple","id":"hjcapple","articlesCount":79,"acceptSubmission":true,"title":"黄二少碎碎念","url":"https:\u002F\u002Fzhuanlan.zhihu.com\u002Fhjcapple","commentPermission":"all","created":1439819496,"updated":1590871586,"imageUrl":"https:\u002F\u002Fpic4.zhimg.com\u002F02aa7a5bb0cd52f91f4deed1c5066d68_720w.jpg?source=172ae18b","author":{"isFollowed":false,"avatarUrlTemplate":"https:\u002F\u002Fpic2.zhimg.com\u002F2447e1332.jpg?source=172ae18b","uid":"27249038327808","userType":"people","isFollowing":false,"urlToken":"huang-jing-cheng","id":"624dfc9564dbd296cb81c515c2fb6ae2","description":"【GitHub】 https:\u002F\u002Fgithub.com\u002Fhjcapple","name":"黄兢成","isAdvertiser":false,"headline":"iOS \u002F Mac \u002F C++ 开发者","gender":1,"url":"\u002Fpeople\u002F624dfc9564dbd296cb81c515c2fb6ae2","avatarUrl":"https:\u002F\u002Fpic2.zhimg.com\u002F2447e1332_l.jpg?source=172ae18b","isOrg":false,"type":"people"},"followers":872,"type":"column"}},"topics":{},"roundtables":{},"favlists":{},"comments":{},"notifications":{},"ebooks":{},"activities":{},"feeds":{},"pins":{},"promotions":{},"drafts":{},"chats":{},"posts":{},"clubs":{},"clubTags":{}},"currentUser":"","account":{"lockLevel":{},"unlockTicketStatus":false,"unlockTicket":null,"challenge":[],"errorStatus":false,"message":"","isFetching":false,"accountInfo":{},"urlToken":{"loading":false}},"settings":{"socialBind":null,"inboxMsg":null,"notification":{},"email":{},"privacyFlag":null,"blockedUsers":{"isFetching":false,"paging":{"pageNo":1,"pageSize":6},"data":[]},"blockedFollowees":{"isFetching":false,"paging":{"pageNo":1,"pageSize":6},"data":[]},"ignoredTopics":{"isFetching":false,"paging":{"pageNo":1,"pageSize":6},"data":[]},"restrictedTopics":null,"laboratory":{}},"notification":{},"people":{"profileStatus":{},"activitiesByUser":{},"answersByUser":{},"answersSortByVotesByUser":{},"answersIncludedByUser":{},"votedAnswersByUser":{},"thankedAnswersByUser":{},"voteAnswersByUser":{},"thankAnswersByUser":{},"topicAnswersByUser":{},"zvideosByUser":{},"articlesByUser":{},"articlesSortByVotesByUser":{},"articlesIncludedByUser":{},"pinsByUser":{},"questionsByUser":{},"commercialQuestionsByUser":{},"favlistsByUser":{},"followingByUser":{},"followersByUser":{},"mutualsByUser":{},"followingColumnsByUser":{},"followingQuestionsByUser":{},"followingFavlistsByUser":{},"followingTopicsByUser":{},"publicationsByUser":{},"columnsByUser":{},"allFavlistsByUser":{},"brands":null,"creationsByUser":{},"creationsSortByVotesByUser":{},"creationsFeed":{},"infinity":{}},"env":{"ab":{"config":{"experiments":[{"expId":"launch-qa_cl_guest-2","expPrefix":"qa_cl_guest","isDynamicallyUpdated":true,"isRuntime":false,"includeTriggerInfo":false},{"expId":"launch-vd_timeguide-2","expPrefix":"vd_timeguide","isDynamicallyUpdated":true,"isRuntime":false,"includeTriggerInfo":false},{"expId":"launch-vd_video_replay-3","expPrefix":"vd_video_replay","isDynamicallyUpdated":true,"isRuntime":false,"includeTriggerInfo":false},{"expId":"launch-vd_zvideo_link-10","expPrefix":"vd_zvideo_link","isDynamicallyUpdated":true,"isRuntime":false,"includeTriggerInfo":false},{"expId":"vd_bullet_gui-2","expPrefix":"vd_bullet_gui","isDynamicallyUpdated":true,"isRuntime":false,"includeTriggerInfo":false},{"expId":"web_nvgt-2_v5","expPrefix":"web_nvgt","isDynamicallyUpdated":true,"isRuntime":false,"includeTriggerInfo":false},{"expId":"Test_Punk-1_v2","expPrefix":"Test_Punk","isDynamicallyUpdated":true,"isRuntime":false,"includeTriggerInfo":false},{"expId":"meta_ebook-2_v1","expPrefix":"meta_ebook","isDynamicallyUpdated":true,"isRuntime":false,"includeTriggerInfo":false},{"expId":"recnew_2th-4_v2","expPrefix":"recnew_2th","isDynamicallyUpdated":true,"isRuntime":false,"includeTriggerInfo":false},{"expId":"hot_card-2_v2","expPrefix":"hot_card","isDynamicallyUpdated":true,"isRuntime":false,"includeTriggerInfo":false},{"expId":"general_1-2_v1","expPrefix":"general_1","isDynamicallyUpdated":true,"isRuntime":false,"includeTriggerInfo":false},{"expId":"se_hour_ctr-2_v1","expPrefix":"se_hour_ctr","isDynamicallyUpdated":true,"isRuntime":false,"includeTriggerInfo":false},{"expId":"correct_gpu-2_v2","expPrefix":"correct_gpu","isDynamicallyUpdated":true,"isRuntime":false,"includeTriggerInfo":false},{"expId":"se_fix_ebook-3_v2","expPrefix":"se_fix_ebook","isDynamicallyUpdated":true,"isRuntime":false,"includeTriggerInfo":false}],"params":[{"id":"web_ad_banner","type":"String","value":"0","layerId":"webgw_layer_3"},{"id":"ge_hard_s_ma","type":"String","value":"0","chainId":"_gene_","layerId":"geli_layer_856","key":3031},{"id":"ge_kocbox","type":"String","value":"0","chainId":"_gene_","layerId":"gese_layer_945","key":3087},{"id":"gue_iosplay","type":"String","value":"0","layerId":"guevd_layer_896"},{"id":"zr_intervene","type":"String","value":"0","chainId":"_all_","layerId":"zrrec_layer_2"},{"id":"se_fix_ebook","type":"Int","value":"1","chainId":"_gene_","layerId":"se_fix_ebook","key":103},{"id":"zr_slotpaidexp","type":"String","value":"1","chainId":"_all_","layerId":"zrrec_layer_5"},{"id":"ge_relation2","type":"String","value":"1","chainId":"_gene_","layerId":"gese_layer_815","key":2796},{"id":"ge_corr","type":"String","value":"1","chainId":"_gene_","layerId":"gese_layer_976","key":3041},{"id":"ge_mixer2","type":"String","value":"0","chainId":"_gene_","layerId":"gese_layer_976","key":3133},{"id":"ge_newbie3","type":"String","value":"0","chainId":"_gene_","layerId":"geus_layer_1074","key":3208},{"id":"li_sp_mqbk","type":"String","value":"0","chainId":"_all_","layerId":"lili_layer_748"},{"id":"gue_goods_card","type":"String","value":"0","layerId":"gueqa_layer_1"},{"id":"general_1","type":"Int","value":"2","chainId":"_gene_","layerId":"general_1","key":8},{"id":"correct_gpu","type":"Int","value":"1","chainId":"_gene_","layerId":"correct_gpu","key":66},{"id":"ge_recall","type":"String","value":"0","chainId":"_gene_","layerId":"gese_layer_1029","key":3110},{"id":"ge_rm_d2q_v2","type":"String","value":"1","chainId":"_gene_","layerId":"gese_layer_1034","key":3105},{"id":"se_ffzx_jushen1","type":"String","value":"0","chainId":"_all_","layerId":"sese_layer_4"},{"id":"tp_dingyue_video","type":"String","value":"0","chainId":"_all_","layerId":"tptp_layer_4"},{"id":"web_collection_guest","type":"String","value":"1","layerId":"webqa_layer_4"},{"id":"ge_sug_v2","type":"String","value":"0","chainId":"_gene_","layerId":"gese_layer_1000","key":3189},{"id":"gue_bullet_second","type":"String","value":"1","layerId":"guevd_layer_1"},{"id":"ge_base_only","type":"String","value":"0","chainId":"_gene_","layerId":"gese_layer_1029","key":3172},{"id":"tp_contents","type":"String","value":"2","chainId":"_all_","layerId":"tptp_layer_627"},{"id":"qap_question_visitor","type":"String","value":" 0","chainId":"_all_","layerId":"qapqa_layer_2"},{"id":"ge_meta_ss","type":"String","value":"0","chainId":"_gene_","layerId":"gese_layer_834","key":3079},{"id":"gue_zvideo_link","type":"String","value":"1","layerId":"guevd_layer_2"},{"id":"gue_bulletmb","type":"String","value":"0","layerId":"guevd_layer_812"},{"id":"pf_adjust","type":"String","value":"0","chainId":"_all_","layerId":"pfus_layer_9"},{"id":"web_nvgt","type":"Int","value":"1","layerId":"web_nvgt"},{"id":"ge_yuzhi_v1","type":"String","value":"1","chainId":"_gene_","layerId":"gese_layer_1029","key":3127},{"id":"ge_cp_zvideo","type":"String","value":"0","chainId":"_gene_","layerId":"gese_layer_742","key":3111},{"id":"ge_spe_rt","type":"String","value":"0","chainId":"_gene_","layerId":"gese_layer_742","key":2970},{"id":"li_panswer_topic","type":"String","value":"0","chainId":"_all_","layerId":"lili_layer_602"},{"id":"ge_sxzx","type":"String","value":"0","chainId":"_gene_","layerId":"gere_layer_990","key":3060},{"id":"ge_entity","type":"String","value":"0","chainId":"_gene_","layerId":"gese_layer_946","key":3036},{"id":"ge_search_ui","type":"String","value":"1","chainId":"_gene_","layerId":"gese_layer_838","key":2898},{"id":"gue_vid_tab","type":"String","value":"0","layerId":"guevd_layer_900"},{"id":"ge_vector","type":"String","value":"0","chainId":"_gene_","layerId":"gese_layer_989","key":3134},{"id":"hot_card","type":"Int","value":"0","chainId":"_gene_","layerId":"hot_card","key":108},{"id":"gue_messrec","type":"String","value":"0","layerId":"gueqa_layer_769"},{"id":"zr_expslotpaid","type":"String","value":"1","chainId":"_all_","layerId":"zrrec_layer_11"},{"id":"ge_usercard1","type":"String","value":"0","chainId":"_gene_","layerId":"gese_layer_742","key":2740},{"id":"ge_newyanzhi","type":"String","value":"0","chainId":"_gene_","layerId":"geus_layer_1019","key":2788},{"id":"pf_noti_entry_num","type":"String","value":"0","chainId":"_all_","layerId":"pfus_layer_718"},{"id":"gue_video_guide","type":"String","value":"1","layerId":"guevd_layer_625"},{"id":"Test_Punk","type":"Int","value":"0","layerId":"Test_Punk"},{"id":"se_hour_ctr","type":"Int","value":"0","chainId":"_gene_","layerId":"se_hour_ctr","key":109},{"id":"tp_topic_style","type":"String","value":"0","chainId":"_all_","layerId":"tptp_layer_4"},{"id":"tp_zrec","type":"String","value":"0","chainId":"_all_","layerId":"tptp_layer_619"},{"id":"gue_playh_an","type":"String","value":"0","layerId":"guevd_layer_622"},{"id":"ge_v068","type":"Int","value":"0","chainId":"_gene_","layerId":"ge_v068","key":139},{"id":"ge_sug_rep","type":"String","value":"1","chainId":"_gene_","layerId":"gese_layer_1034","key":3158},{"id":"ge_upload","type":"String","value":"0","chainId":"_gene_","layerId":"geus_layer_839","key":2892},{"id":"gue_profile_video","type":"String","value":"1","layerId":"guevd_layer_5"},{"id":"li_edu_page","type":"String","value":"old","chainId":"_all_","layerId":"lili_layer_580"},{"id":"ge_time","type":"String","value":"0","chainId":"_gene_","layerId":"gese_layer_1047","key":3147},{"id":"ge_newcard","type":"String","value":"0","chainId":"_gene_","layerId":"geus_layer_839","key":2997},{"id":"ge_query_pv","type":"Int","value":"0","chainId":"_gene_","layerId":"ge_query_pv","key":58},{"id":"pfd_newbie2","type":"Int","value":"0","chainId":"_gene_","layerId":"pfd_newbie2","key":71},{"id":"gue_q_share","type":"String","value":"0","layerId":"gueqa_layer_647"},{"id":"gue_video_replay","type":"String","value":"2","layerId":"guevd_layer_3"},{"id":"li_video_section","type":"String","value":"0","chainId":"_all_","layerId":"lili_layer_7"},{"id":"gue_card_test","type":"String","value":"1","layerId":"gueqa_layer_2"},{"id":"gue_bullet_guide","type":"String","value":"分享你刚编的弹幕","layerId":"guevd_layer_0"},{"id":"gue_cdzixun","type":"String","value":"0","layerId":"gueqa_layer_3"},{"id":"gue_visit_n_artcard","type":"String","value":"1","layerId":"gueqa_layer_579"},{"id":"web_mem_tab","type":"String","value":"1","layerId":"webtop_layer_1006"},{"id":"ge_rec_2th","type":"String","value":"11","chainId":"_gene_","layerId":"geli_layer_965","key":3023},{"id":"gue_art_ui","type":"String","value":"0","layerId":"gueqa_layer_647"},{"id":"show_ad","type":"Int","value":"0","chainId":"_gene_","layerId":"show_ad","key":27},{"id":"web_scl_rec","type":"String","value":"0","layerId":"webgw_layer_759"},{"id":"web_answerlist_ad","type":"String","value":"0","layerId":"webqa_layer_1"},{"id":"web_unfriendly_comm","type":"String","value":"0","layerId":"webre_layer_1"},{"id":"ge_recency","type":"String","value":"0","chainId":"_gene_","layerId":"gese_layer_1047","key":3072},{"id":"ge_guess","type":"String","value":"0","chainId":"_gene_","layerId":"gese_layer_938","key":2912},{"id":"ge_aaaa","type":"Int","value":"0","chainId":"_gene_","layerId":"ge_aaaa","key":121},{"id":"gue_self_censoring","type":"String","value":"1","layerId":"gueqa_layer_1"},{"id":"top_test_4_liguangyi","type":"String","value":"1","chainId":"_all_","layerId":"iosus_layer_1"},{"id":"ge_prf_rec","type":"String","value":"0","chainId":"_gene_","layerId":"getop_layer_991","key":3040},{"id":"gue_sharp","type":"String","value":"1","layerId":"guevd_layer_686"},{"id":"pfd_newbie","type":"Int","value":"0","chainId":"_gene_","layerId":"pfd_newbie","key":63},{"id":"gue_art2qa","type":"String","value":"0","layerId":"gueqa_layer_579"},{"id":"ge_mixer","type":"String","value":"0","chainId":"_gene_","layerId":"gese_layer_1009","key":3106},{"id":"ge_tbw","type":"String","value":"0","chainId":"_gene_","layerId":"gese_layer_1071","key":3201},{"id":"web_heifetz_grow_ad","type":"String","value":"1","layerId":"webgw_layer_3"},{"id":"ge_v_rank_v3","type":"String","value":"0","chainId":"_gene_","layerId":"gese_layer_1047","key":2966},{"id":"qap_question_author","type":"String","value":"0","chainId":"_all_","layerId":"qapqa_layer_2"},{"id":"web_audit_01","type":"String","value":"case1","layerId":"webre_layer_1"},{"id":"meta_ebook","type":"Int","value":"1","layerId":"meta_ebook"},{"id":"ge_item","type":"String","value":"0","chainId":"_gene_","layerId":"gese_layer_945","key":2971},{"id":"gue_v_serial","type":"String","value":"1","layerId":"guevd_layer_695"},{"id":"web_sem_ab","type":"String","value":"1","layerId":"webgw_layer_3"},{"id":"web_login","type":"String","value":"0","layerId":"webgw_layer_759"},{"id":"gue_recmess","type":"String","value":"0","layerId":"gueqa_layer_795"},{"id":"gue_andplayd","type":"String","value":"0","layerId":"guevd_layer_686"},{"id":"gue_fo_recom","type":"String","value":"0","layerId":"gueqa_layer_780"},{"id":"ge_emoji","type":"String","value":"0","chainId":"_gene_","layerId":"getp_layer_827","key":3209},{"id":"recnew_2th","type":"Int","value":"22","layerId":"recnew_2th"},{"id":"web_answer_list_ad","type":"String","value":"1","layerId":"webqa_layer_4"},{"id":"ge_infinity6","type":"String","value":"0","chainId":"_gene_","layerId":"gese_layer_815","key":2817},{"id":"ge_com_sup","type":"String","value":"0","chainId":"_gene_","layerId":"gese_layer_859","key":2891},{"id":"ge_entityner","type":"String","value":"0","chainId":"_gene_","layerId":"gese_layer_859","key":3177},{"id":"web_creator_route","type":"String","value":"1","layerId":"webtop_layer_1"},{"id":"zanswer","type":"Int","value":"0","layerId":"zanswer"},{"id":"ge_video","type":"String","value":"0","chainId":"_gene_","layerId":"geli_layer_856","key":2831},{"id":"gue_repost","type":"String","value":"0","layerId":"gueqa_layer_671"},{"id":"ge_dipin_pre","type":"String","value":"0","chainId":"_gene_","layerId":"gese_layer_1000","key":3124},{"id":"li_vip_verti_search","type":"String","value":"0","chainId":"_all_","layerId":"lili_layer_2"},{"id":"li_paid_answer_exp","type":"String","value":"0","chainId":"_all_","layerId":"lili_layer_3"},{"id":"ge_vec_bert","type":"String","value":"0","chainId":"_gene_","layerId":"gese_layer_1000","key":3154},{"id":"ge_flow_join","type":"String","value":"0","chainId":"_gene_","layerId":"getp_layer_872","key":2988},{"id":"web_column_auto_invite","type":"String","value":"0","layerId":"webqa_layer_1"}],"chains":[{"chainId":"_all_"}],"encodedParams":"CmbXCw8MZwDsCuELPQyIDAgAQgAmDCEMdQxkDAcMNwwnDJoL9AvcC1ILPgxsALQK5AptAIsAVgxMC0sMtQs6AEcAzwsbAAAMYAt5AOALPwAiDIEMlgubC4kMAQtLC2kMDws0DFIMrAsSMwAAAQEBAAACAQABAAAAAQAAAAABAAAAAAAAAQAAAAAACwAAAAAAAAAAAAAAAAAAAAAAAA=="},"triggers":{}},"userAgent":{"Edge":false,"IE":false,"Wechat":false,"Weibo":false,"QQ":false,"MQQBrowser":false,"Qzone":false,"Mobile":false,"Android":false,"iOS":false,"isAppleDevice":false,"Zhihu":false,"ZhihuHybrid":false,"isBot":false,"Tablet":false,"UC":false,"Sogou":false,"Qihoo":false,"Baidu":false,"BaiduApp":false,"Safari":false,"GoogleBot":false,"AndroidDaily":false,"iOSDaily":false,"WxMiniProgram":false,"BaiduMiniProgram":false,"QQMiniProgram":false,"JDMiniProgram":false,"isWebView":false,"isMiniProgram":false,"origin":"Python-urllib\u002F3.8"},"appViewConfig":{},"ctx":{"path":"\u002Fp\u002F95299255","query":{},"href":"http:\u002F\u002Fzhuanlan.zhihu.com\u002Fp\u002F95299255","host":"zhuanlan.zhihu.com"},"trafficSource":"production","edition":{"beijing":true,"baidu":false,"sogou":false,"baiduBeijing":false,"sogouBeijing":false,"sogouInput":false,"baiduSearch":false,"googleSearch":false,"miniProgram":false,"xiaomi":false},"theme":"light","enableShortcut":true,"referer":"","xUDID":"","mode":"ssr","conf":{},"xTrafficFreeOrigin":"","ipInfo":{"cityName":"北京","countryName":"中国","regionName":"北京","countryCode":"CN"},"logged":false,"vars":{"passThroughHeaders":{}}},"me":{"columnContributions":[]},"label":{"recognizerLists":{}},"ecommerce":{},"comments":{"pagination":{},"collapsed":{},"reverse":{},"reviewing":{},"conversation":{},"parent":{}},"commentsV2":{"stickers":[],"commentWithPicPermission":{},"notificationsComments":{},"pagination":{},"collapsed":{},"reverse":{},"reviewing":{},"conversation":{},"conversationMore":{},"parent":{}},"pushNotifications":{"default":{"isFetching":false,"isDrained":false,"ids":[]},"follow":{"isFetching":false,"isDrained":false,"ids":[]},"vote_thank":{"isFetching":false,"isDrained":false,"ids":[]},"currentTab":"default","notificationsCount":{"default":0,"follow":0,"vote_thank":0}},"messages":{"data":{},"currentTab":"common","messageCount":0},"register":{"registerValidateSucceeded":null,"registerValidateErrors":{},"registerConfirmError":null,"sendDigitsError":null,"registerConfirmSucceeded":null},"login":{"loginUnregisteredError":false,"loginBindWechatError":false,"loginConfirmError":null,"sendDigitsError":null,"needSMSIdentify":false,"validateDigitsError":false,"loginConfirmSucceeded":null,"qrcodeLoginToken":"","qrcodeLoginScanStatus":0,"qrcodeLoginError":null,"qrcodeLoginReturnNewToken":false},"active":{"sendDigitsError":null,"activeConfirmSucceeded":null,"activeConfirmError":null},"switches":{},"captcha":{"captchaNeeded":false,"captchaValidated":false,"captchaBase64String":null,"captchaValidationMessage":null,"loginCaptchaExpires":false},"sms":{"supportedCountries":[]},"chat":{"chats":{},"inbox":{"recents":{"isFetching":false,"isDrained":false,"isPrevDrained":false,"result":[],"next":null,"key":null},"strangers":{"isFetching":false,"isDrained":false,"isPrevDrained":false,"result":[],"next":null,"key":null},"friends":{"isFetching":false,"isDrained":false,"isPrevDrained":false,"result":[],"next":null,"key":null},"search":{"isFetching":false,"isDrained":false,"isPrevDrained":false,"result":[],"next":null,"key":null},"config":{"newCount":0,"strangerMessageSwitch":false,"strangerMessageUnread":false,"friendCount":0}},"global":{"isChatMqttExisted":false}},"emoticons":{"emoticonGroupList":[],"emoticonGroupDetail":{}},"creator":{"currentCreatorUrlToken":null,"homeData":{"recommendQuestions":[]},"tools":{"question":{"invitationCount":{"questionFolloweeCount":0,"questionTotalCount":0},"goodatTopics":[]},"customPromotion":{"itemLists":{}},"recommend":{"recommendTimes":{}}},"explore":{"academy":{"tabs":[],"article":{}}},"rights":[],"rightsStatus":{},"levelUpperLimit":10,"account":{"growthLevel":{}},"mcn":{},"applyStatus":{},"videoSupport":{},"mcnManage":{},"tasks":{},"recentlyCreated":[]},"answers":{"voters":{},"copyrightApplicants":{},"favlists":{},"newAnswer":{},"concernedUpvoters":{},"simpleConcernedUpvoters":{},"paidContent":{},"settings":{}},"recommendation":{"homeRecommendations":[]},"shareTexts":{},"articles":{"voters":{}},"previewPost":{},"favlists":{"relations":{}},"columns":{"voters":{}},"reward":{"answer":{},"article":{},"question":{}},"video":{"data":{},"shareVideoDetail":{},"last":{}},"topstory":{"recommend":{"isFetching":false,"isDrained":false,"afterId":0,"items":[],"next":null},"follow":{"isFetching":false,"isDrained":false,"afterId":0,"items":[],"next":null},"room":{"meta":{},"isFetching":false,"afterId":0,"items":[],"next":null},"followWonderful":{"isFetching":false,"isDrained":false,"afterId":0,"items":[],"next":null},"sidebar":null,"announcement":{},"hotListCategories":[],"hotList":[],"guestFeeds":{"isFetching":false,"isDrained":false,"afterId":0,"items":[],"next":null},"followExtra":{"isNewUser":null,"isFetched":false,"followCount":0,"followers":[]},"hotDaily":{"data":[],"paging":{}},"hotHighlight":{"isFetching":false,"isDrained":false,"data":[],"paging":{}}},"readStatus":{},"column":{},"requestColumn":{"categories":[],"error":null},"articleContribution":{"contributeRequests":[],"deleteContributeIdList":[],"handledContributeIdList":[],"recommendedColumns":[],"pinnedColumns":[],"sentContributeRequestsIdList":[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,"hjcapple"]},"columnContribution":{"contributeRequests":[],"autoInviteEnabled":false,"recommendedContributors":[],"contributionInvitation":null},"draftHistory":{"history":{},"drafts":{}},"upload":{},"articleDraft":{"titleImage":"","titleImageSize":{},"isTitleImageFullScreen":false,"canTitleImageFullScreen":false,"title":"","titleImageUploading":false,"error":"","content":"","draftLoading":false,"updating":false,"globalLoading":false,"pendingVideo":{"resource":null,"error":null},"deleteFail":{"fail":false},"recommendTopics":[],"selectedColumn":0,"articleDisclaimers":[]},"articleDrafts":{"isDrained":false,"isLoading":false,"items":[]},"columnAutocomplete":{"users":[],"friends":[]},"columnCollection":{},"userProfit":{"permission":{"permissionStatus":{"zhiZixuan":0,"recommend":-1,"task":0,"plugin":0},"visible":false}},"mcn":{"bindInfo":{},"memberCategoryList":[],"producerList":[],"categoryList":[],"lists":{},"banners":{},"protocolStatus":{"isAgreedNew":true,"isAgreedOld":true},"probationCountdownDays":0},"zvideos":{"campaigns":{},"tagoreCategory":[],"recommendations":{},"insertable":{},"recruit":{"form":{"platform":"","nickname":"","followerCount":"","domain":"","contact":""},"submited":false,"ranking":[]},"club":{}},"republish":{}},"fetchHost":"www.zhihu.com","subAppName":"column"}</script><script src="https://static.zhihu.com/heifetz/vendor.546efe75409c9aff627d.js"></script><script src="https://static.zhihu.com/heifetz/column.app.283f44f21df1b4e62e5c.js"></script></body><script src="https://hm.baidu.com/hm.js?98beee57fd2ef70ccdd5ca52b9740c49" async=""></script></html>