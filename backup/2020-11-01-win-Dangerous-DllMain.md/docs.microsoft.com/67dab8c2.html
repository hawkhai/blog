<!DOCTYPE html>




















































<html class="hasSidebar hasPageActions hasBreadcrumb conceptual has-default-focus theme-light" lang="en-us" dir="ltr" data-css-variable-support="true" data-authenticated="false" data-auth-status-determined="false" data-target="docs" x-ms-format-detection="none">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<meta property="og:title" content="Dynamic-Link Library Best Practices - Win32 apps" />
	<meta property="og:type" content="website" />
	<meta property="og:url" content="https://docs.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-best-practices" />

	<meta name="twitter:card" content="summary" />
	<meta name="twitter:site" content="@docsmsft" />


	<meta name="author" content="mcleanbyron" />
<meta name="breadcrumb_path" content="/windows/desktop/breadcrumb/toc.json" />
<meta name="depot_name" content="MSDN.win32" />
<meta name="Description" content="Creating DLLs presents a number of challenges for developers." />
<meta name="document_id" content="93e1c2ed-201a-3c4b-14ea-550153cf3bb6" />
<meta name="document_version_independent_id" content="d260c375-fe29-759a-a05e-9c51693e6687" />
<meta name="gitcommit" content="https://github.com/MicrosoftDocs/win32-pr/blob/9daa384a1d1f77e7fb7c8966fdfd737fb2f7b8c6/desktop-src/Dlls/dynamic-link-library-best-practices.md" />
<meta name="locale" content="en-us" />
<meta name="ms.assetid" content="44EFC4B5-7A2F-43A6-914E-D4EB7446AC35" />
<meta name="ms.author" content="mcleans" />
<meta name="ms.date" content="05/31/2018" />
<meta name="ms.prod" content="desktop" />
<meta name="ms.technology" content="system-services" />
<meta name="ms.topic" content="article" />
<meta name="original_content_git_url" content="https://github.com/MicrosoftDocs/win32-pr/blob/live/desktop-src/Dlls/dynamic-link-library-best-practices.md" />
<meta name="search.ms_docsetname" content="win32" />
<meta name="search.ms_product" content="MSDN" />
<meta name="search.ms_sitename" content="Docs" />
<meta name="site_name" content="Docs" />
<meta name="uhfHeaderId" content="MSDocsHeader-WinDevCenter" />
<meta name="updated_at" content="2020-08-19 09:41 PM" />
<meta name="page_type" content="conceptual" />
<meta name="toc_rel" content="toc.json" />
<meta name="pdf_url_template" content="https://docs.microsoft.com/pdfstore/en-us/MSDN.win32/{branchName}{pdfName}" />
<meta name="word_count" content="1697" />


	<meta name="scope" content="Windows, Desktop" />
<link href="https://docs.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-best-practices" rel="canonical">
	<title>Dynamic-Link Library Best Practices - Win32 apps | Microsoft Docs</title>

		<link rel="stylesheet" href="/_themes/docs.theme/master/zh-cn/_themes/styles/2dc4f037.site-ltr.css ">

	<link rel="stylesheet" href="/_themes/docs.theme/master/zh-cn/_themes/styles/55917fe3.conceptual.css ">


	<script>
	var msDocs = {
		data: {
			timeOrigin: Date.now(),
			contentLocale: 'en-us',
			contentDir: 'ltr',
			userLocale: 'zh-cn',
			userDir: 'ltr',
			pageTemplate: 'Conceptual',
			brand: '',
			context: {

			},
			hasBinaryRating: true,
			hasGithubIssues: false,
			showFeedbackReport: false,
			enableTutorialFeedback: false,
			feedbackSystem: 'None',
			feedbackGitHubRepo: '',
			feedbackProductUrl: '',
			contentGitUrl: 'https://github.com/MicrosoftDocs/win32/blob/docs/desktop-src/Dlls/dynamic-link-library-best-practices.md',
			extendBreadcrumb: false,
			isEditDisplayable: true,
			hideViewSource: false,
			hasPageActions: true,
			hasBookmark: true,
			hasShare: true,
			hasRecommendations: false,
			contributors: [
						{ name: "McLean Schofield", url: "https://github.com/mcleanbyron" },
						{ name: "David Coulter", url: "https://github.com/DCtheGeek" },
						{ name: "drew batchelor", url: "https://github.com/drewbatgit" },
						{ name: "Mike Jacobs", url: "https://github.com/mijacobs" },
						{ name: "Michael Satran", url: "https://github.com/msatranjr" }
],
		},
		functions:{}
	};
	</script>
	<script src="https://az725175.vo.msecnd.net/scripts/jsll-4.js"></script>
	<script nomodule src="/static/third-party/bluebird/3.5.0/bluebird.min.js" integrity="sha384-aD4BDeDGeLXLpPK4yKeqtZQa9dv4a/7mQ+4L5vwshIYH1Mc2BrXvHd32iHzYCQy5" crossorigin="anonymous"></script>
	<script nomodule src="/static/third-party/fetch/3.0.0/fetch.umd.min.js" integrity="sha384-EQIXrC5K2+7X8nGgLkB995I0/6jfAvvyG1ieZ+WYGxgJHFMD/alsG9fSDWvzb5Y1" crossorigin="anonymous"></script>
	<script nomodule src="/static/third-party/template/1.4.0/template.min.js" integrity="sha384-1zKzI6ldTVHMU7n0W2HpE/lhHI+UG4D9IIaxbj3kT2UhCWicdTuJkTtnKuu0CQzN" crossorigin="anonymous"></script>
	<script nomodule src="/static/third-party/url/0.5.7/url.min.js" integrity="sha384-vn7xBMtpSTfzaTRWxj0kVq0UcsbBrTOgZ/M1ISHqe1V358elYva+lfiEC+T8jLPc" crossorigin="anonymous"></script>
	<script src="/_themes/docs.theme/master/zh-cn/_themes/scripts/8edb7104.index-polyfills.js"></script>
		<script src="/static/third-party/qrious/4.0.2-r1/qrious.min.js" integrity="sha384-h/SmU/qxwYnRlzklg9PKWpDwyma9UmKuOB//Pz6Cov5KkEqcaFF0vod43/XhoeyJ" crossorigin="anonymous"></script>
		<script src="/_themes/docs.theme/master/zh-cn/_themes/scripts/215a1be8.index-docs.js"></script>
</head>

<body lang="zh-cn" dir="ltr">
<div class="header-holder has-default-focus">
	<a href="#main" class="skip-to-main-link has-outline-color-text visually-hidden-until-focused is-fixed has-inner-focus focus-visible has-top-zero has-left-zero has-right-zero has-padding-medium has-text-centered has-body-background-medium" tabindex="1">跳转至主内容</a>
	<div id="learn-together-banner-holder" class="has-default-focus has-overflow-hidden">
	</div>
	<div hidden id="cookie-consent-holder"></div>
	<!-- liquid-tag banners global -->
	<div id="headerAreaHolder" data-bi-name="header">
<header role="banner" itemscope="itemscope" itemtype="http://schema.org/Organization">
	<div class="nav-bar">
		<div class="nav-bar-brand">
			<a itemprop="url" href="https://www.microsoft.com" aria-label="Microsoft" class="nav-bar-button">
				<div class="nav-bar-logo has-background-image theme-display is-light" role="presentation" aria-hidden="true" itemprop="logo" itemscope="itemscope"></div>
				<div class="nav-bar-logo has-background-image theme-display is-dark is-high-contrast" role="presentation" aria-hidden="true" itemprop="logo" itemscope="itemscope"></div>
			</a>
		</div>
	</div>
	<div class="nav-bar has-border-top is-hidden-mobile"></div>
</header>	</div>

				<div class="content-header uhf-container has-padding has-default-focus has-border-bottom-none" data-bi-name="content-header">
				<nav class="has-padding-none has-padding-left-medium-tablet has-padding-right-medium-tablet has-padding-left-none-uhf-tablet has-padding-left-none-uhf-tablet has-padding-none-desktop has-flex-grow" data-bi-name="breadcrumb" itemscope itemtype="http://schema.org/BreadcrumbList" role="navigation" aria-label="痕迹">
					<ul id="page-breadcrumbs" class="breadcrumbs">
					</ul>
				</nav>
			<div class="content-header-controls">
				<button type="button" class="contents-button button" data-bi-name="contents-expand" aria-haspopup="true">
					<span class="icon"><span class="docon docon-menu" aria-hidden="true"></span></span>
					<span class="contents-expand-title">目录</span>
				</button>
				<button type="button" class="ap-collapse-behavior ap-expanded button" data-bi-name="ap-collapse" aria-controls="action-panel">
					<span class="icon"><span class="docon docon-exit-mode" aria-hidden="true"></span></span>
					<span>退出焦点模式</span>
				</button>
			</div>
			<div class="has-padding-none-tablet has-padding-medium is-size-small is-flex-touch has-flex-justify-content-space-between-touch has-flex-grow">
				<ul class="is-hidden-mobile action-list has-flex-justify-content-start has-flex-justify-content-end-tablet is-flex is-flex-row has-flex-wrap has-flex-grow is-unstyled">
					<li>
						<button type="button" class="bookmark button is-text has-inner-focus is-small is-icon-only-touch" data-list-type="bookmarks" data-bi-name="bookmark" title="用书签标记此页面">
							<span class="icon" aria-hidden="true">
								<span class="docon docon-single-bookmark"></span>
							</span>
							<span class="bookmark-status is-visually-hidden-touch is-hidden-portrait">书签</span>
						</button>
					</li>
							<li id="contenteditbtn">
								<a href="https://github.com/MicrosoftDocs/win32/blob/docs/desktop-src/Dlls/dynamic-link-library-best-practices.md" class="button is-text has-inner-focus is-icon-only-touch is-small" title="编辑本文" data-bi-name="edit" data-original_content_git_url="https://github.com/MicrosoftDocs/win32-pr/blob/live/desktop-src/Dlls/dynamic-link-library-best-practices.md" data-original_content_git_url_template="{repo}/blob/{branch}/desktop-src/Dlls/dynamic-link-library-best-practices.md" data-pr_repo="" data-pr_branch="">
								<span class="icon" aria-hidden="true">
									<span class="docon docon-edit-outline"></span>
								</span>
								<span class="is-visually-hidden-touch is-hidden-portrait">编辑</span>
							</a>
						</li>
					<li>
<div class="sharing dropdown has-caret">
	<button class="dropdown-trigger button is-text is-fullwidth has-flex-justify-content-start has-inner-focus is-small is-icon-only-touch" aria-controls="sharing-menu" aria-expanded="false" title="共享本文" data-bi-name="share">
		<span class="icon" aria-hidden="true">
			<span class="docon docon-sharing"></span>
		</span>
		<span class="is-visually-hidden-touch is-hidden-portrait">共享</span>
	</button>
	<div class="dropdown-menu has-padding-small" id="sharing-menu">
		<ul data-bi-name="share-links">
			<li>
				<a class="button is-text is-fullwidth has-flex-justify-content-start has-inner-focus is-small share-twitter" data-bi-name="twitter">
					<span class="icon">
						<span class="docon docon-brand-twitter has-text-primary" aria-hidden="true"></span>
					</span>
					<span>Twitter</span>
				</a>
			</li>
			<li>
				<a class="button is-text is-fullwidth has-flex-justify-content-start has-inner-focus is-small share-linkedin" data-bi-name="linkedin">
					<span class="icon">
						<span class="docon docon-brand-linkedin has-text-primary" aria-hidden="true"></span>
					</span>
					<span>LinkedIn</span>
				</a>
			</li>
			<li>
				<a class="button is-text is-fullwidth has-flex-justify-content-start has-inner-focus is-small share-facebook" data-bi-name="facebook">
					<span class="icon">
						<span class="docon docon-brand-facebook has-text-primary" aria-hidden="true"></span>
					</span>
					<span>Facebook</span>
				</a>
			</li>
			<li>
				<a class="button is-text is-fullwidth has-flex-justify-content-start has-inner-focus is-small share-email" data-bi-name="email">
					<span class="icon">
						<span class="docon docon-mail-message-fill has-text-primary" aria-hidden="true"></span>
					</span>
					<span>电子邮件</span>
				</a>
			</li>
			<li>
				<span class="button is-text is-fullwidth has-flex-justify-content-start has-inner-focus is-small share-wechat has-padding-top-extra-small has-padding-left-medium has-padding-right-medium">
					<span class="icon">
						<span class="docon docon-wechat has-text-primary" data-bi-name="wechat" aria-hidden="true"></span>
					</span>
					<span>微信</span>
				</span>
			</li>
			<li>
				<canvas class="qr-code"></canvas>
			</li>
		</ul>
	</div>
</div>					</li>
				</ul>
				<button type="button" class="has-border contents-button button is-small is-text is-hidden-tablet has-inner-focus" aria-label="目录" data-bi-name="contents-expand">
					<span class="icon">
						<span class="docon docon-editor-list-bullet" aria-hidden="true"></span>
					</span>
					<span class="contents-expand-title">目录</span>
				</button>
				<div class="is-invisible"></div>
				<div class="is-hidden-tablet level-item is-flexible level-right">
					<button type="button" class="page-actions-button button is-small is-text is-hidden-tablet has-inner-focus has-border is-full-height  has-margin-left-small" aria-label="页面操作" data-bi-name="pageactions">
						<span class="icon">
							<span class="docon docon-more-vertical" aria-hidden="true"></span>
						</span>
					</button>
				</div>
			</div>
		</div>



	<div id="disclaimer-holder" class="has-overflow-hidden has-default-focus">
		<!-- liquid-tag banners sectional -->
	</div>
	</div>

	<div class="mainContainer  uhf-container has-top-padding  has-default-focus" data-bi-name="body">

		<div class="columns has-large-gaps is-gapless-mobile ">

			<div id="left-container" class="left-container is-hidden-mobile column is-one-third-tablet is-one-quarter-desktop">
				<nav id="affixed-left-container" class="is-fixed is-flex is-flex-column" role="navigation" aria-label="主要"></nav>
			</div>

			<section class="primary-holder column is-two-thirds-tablet is-three-quarters-desktop">
				<div class="columns is-gapless-mobile has-large-gaps ">


				<div id="main-column" class="column  is-full is-four-fifths-desktop ">

					<main id="main" role="main" class="content " data-bi-name="content" lang="en-us" dir="ltr">



						<h1 id="dynamic-link-library-best-practices">Dynamic-Link Library Best Practices</h1>

						<ul class="metadata page-metadata" data-bi-name="page info" lang="zh-cn" dir="ltr">
							<li>
								<time class="is-invisible" data-article-date aria-label="文章评审日期" datetime="2018-05-31T00:00:00.000Z" data-article-date-source="ms.date">05/31/2018</time>
							</li>
									<li class="readingTime">8 分钟可看完</li>
								<li class="contributors-holder">
									<ul class="facepile has-margin-left-none is-small" data-bi-name="contributors">
														<li class="facepile-item">
															<a href="https://github.com/mcleanbyron" title="McLean Schofield" aria-label="McLean SchofieldGithub profile" data-src="https://github.com/mcleanbyron.png?size=32" data-contributor-name="McLean Schofield" class="facepile-item-coin"
															>
																<img class="facepile-item-coin-image durable-image" aria-hidden="true" src="https://github.com/mcleanbyron.png?size=32" role="presentation" onerror="this.hidden=true; this.className='facepile-item-coin-image durable-image has-error';"/>
																<span class="facepile-item-coin-text durable-image-fallback facepile-item-teal"aria-hidden="true">M</span>
															</a>
														</li>
														<li class="facepile-item">
															<a href="https://github.com/DCtheGeek" title="David Coulter" aria-label="David CoulterGithub profile" data-src="https://github.com/DCtheGeek.png?size=32" data-contributor-name="David Coulter" class="facepile-item-coin"
															>
																<img class="facepile-item-coin-image durable-image" aria-hidden="true" src="https://github.com/DCtheGeek.png?size=32" role="presentation" onerror="this.hidden=true; this.className='facepile-item-coin-image durable-image has-error';"/>
																<span class="facepile-item-coin-text durable-image-fallback facepile-item-red"aria-hidden="true">D</span>
															</a>
														</li>
														<li class="facepile-item">
															<a href="https://github.com/drewbatgit" title="drew batchelor" aria-label="drew batchelorGithub profile" data-src="https://github.com/drewbatgit.png?size=32" data-contributor-name="drew batchelor" class="facepile-item-coin"
															>
																<img class="facepile-item-coin-image durable-image" aria-hidden="true" src="https://github.com/drewbatgit.png?size=32" role="presentation" onerror="this.hidden=true; this.className='facepile-item-coin-image durable-image has-error';"/>
																<span class="facepile-item-coin-text durable-image-fallback facepile-item-blue"aria-hidden="true">d</span>
															</a>
														</li>
														<li class="facepile-item">
															<a href="https://github.com/mijacobs" title="Mike Jacobs" aria-label="Mike JacobsGithub profile" data-src="https://github.com/mijacobs.png?size=32" data-contributor-name="Mike Jacobs" class="facepile-item-coin"
															>
																<img class="facepile-item-coin-image durable-image" aria-hidden="true" src="https://github.com/mijacobs.png?size=32" role="presentation" onerror="this.hidden=true; this.className='facepile-item-coin-image durable-image has-error';"/>
																<span class="facepile-item-coin-text durable-image-fallback facepile-item-teal"aria-hidden="true">M</span>
															</a>
														</li>
														<li class="facepile-item">
															<a href="https://github.com/msatranjr" title="Michael Satran" aria-label="Michael SatranGithub profile" data-src="https://github.com/msatranjr.png?size=32" data-contributor-name="Michael Satran" class="facepile-item-coin"
															>
																<img class="facepile-item-coin-image durable-image" aria-hidden="true" src="https://github.com/msatranjr.png?size=32" role="presentation" onerror="this.hidden=true; this.className='facepile-item-coin-image durable-image has-error';"/>
																<span class="facepile-item-coin-text durable-image-fallback facepile-item-red"aria-hidden="true">M</span>
															</a>
														</li>
									</ul>
								</li>
						</ul>

						<nav id="center-doc-outline" class="doc-outline is-hidden-desktop" data-bi-name="intopic toc" role="navigation" aria-label="文章大纲">
							<h3>本文内容</h3>
						</nav>

						<!-- <content> -->
							<p>**Updated: **</p>
<ul>
<li>May 17, 2006</li>
</ul>
<p><strong>Important APIs</strong></p>
<ul>
<li><a href="dllmain" data-linktype="relative-path"><strong>DllMain</strong></a></li>
<li><a href="/en-us/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa" data-linktype="absolute-path"><strong>LoadLibraryEx</strong></a></li>
<li><a href="/en-us/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessa" data-linktype="absolute-path"><strong>CreateProcess</strong></a></li>
</ul>
<p>Creating DLLs presents a number of challenges for developers. DLLs do not have system-enforced versioning. When multiple versions of a DLL exist on a system, the ease of being overwritten coupled with the lack of a versioning schema creates dependency and API conflicts. Complexity in the development environment, the loader implementation, and the DLL dependencies has created fragility in load order and application behavior. Lastly, many applications rely on DLLs and have complex sets of dependencies that must be honored for the applications to function properly. This document provides guidelines for DLL developers to help in building more robust, portable, and extensible DLLs.</p>
<p>Improper synchronization within <a href="dllmain" data-linktype="relative-path"><strong>DllMain</strong></a> can cause an application to deadlock or access data or code in an uninitialized DLL. Calling certain functions from within <strong>DllMain</strong> causes such problems.</p>
<p><img src="images/fig1.png" alt="what happens when a library is loaded" data-linktype="relative-path"/></p>
<h2 id="general-best-practices">General Best Practices</h2>
<p><a href="dllmain" data-linktype="relative-path"><strong>DllMain</strong></a> is called while the loader-lock is held. Therefore, significant restrictions are imposed on the functions that can be called within <strong>DllMain</strong>. As such, <strong>DllMain</strong> is designed to perform minimal initialization tasks, by using a small subset of the Microsoft® Windows® API. You cannot call any function in <strong>DllMain</strong> that directly or indirectly tries to acquire the loader lock. Otherwise, you will introduce the possibility that your application deadlocks or crashes. An error in a <strong>DllMain</strong> implementation can jeopardize the entire process and all of its threads.</p>
<p>The ideal <a href="dllmain" data-linktype="relative-path"><strong>DllMain</strong></a> would be just an empty stub. However, given the complexity of many applications, this is generally too restrictive. A good rule of thumb for <strong>DllMain</strong> is to postpone as much initialization as possible. Lazy initialization increases robustness of the application because this initialization is not performed while the loader lock is held. Also, lazy initialization enables you to safely use much more of the Windows API.</p>
<p>Some initialization tasks cannot be postponed. For example, a DLL that depends on a configuration file should fail to load if the file is malformed or contains garbage. For this type of initialization, the DLL should attempt the action and fail quickly rather than waste resources by completing other work.</p>
<p>You should never perform the following tasks from within <a href="dllmain" data-linktype="relative-path"><strong>DllMain</strong></a>:</p>
<ul>
<li>Call <a href="/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya" data-linktype="absolute-path"><strong>LoadLibrary</strong></a> or <a href="/en-us/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa" data-linktype="absolute-path"><strong>LoadLibraryEx</strong></a> (either directly or indirectly). This can cause a deadlock or a crash.</li>
<li>Call <a href="/en-us/windows/desktop/api/winnls/nf-winnls-getstringtypea" data-linktype="absolute-path"><strong>GetStringTypeA</strong></a>, <a href="/en-us/windows/win32/api/stringapiset/nf-stringapiset-getstringtypeexw" data-linktype="absolute-path"><strong>GetStringTypeEx</strong></a>, or <a href="/en-us/windows/desktop/api/stringapiset/nf-stringapiset-getstringtypew" data-linktype="absolute-path"><strong>GetStringTypeW</strong></a> (either directly or indirectly). This can cause a deadlock or a crash.</li>
<li>Synchronize with other threads. This can cause a deadlock.</li>
<li>Acquire a synchronization object that is owned by code that is waiting to acquire the loader lock. This can cause a deadlock.</li>
<li>Initialize COM threads by using <a href="/en-us/windows/desktop/api/combaseapi/nf-combaseapi-coinitializeex" data-linktype="absolute-path"><strong>CoInitializeEx</strong></a>. Under certain conditions, this function can call <a href="/en-us/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa" data-linktype="absolute-path"><strong>LoadLibraryEx</strong></a>.</li>
<li>Call the registry functions. These functions are implemented in Advapi32.dll. If Advapi32.dll is not initialized before your DLL, the DLL can access uninitialized memory and cause the process to crash.</li>
<li>Call <a href="/en-us/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createprocessa" data-linktype="absolute-path"><strong>CreateProcess</strong></a>. Creating a process can load another DLL.</li>
<li>Call <a href="/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-freelibraryandexitthread" data-linktype="absolute-path"><strong>ExitThread</strong></a>. Exiting a thread during DLL detach can cause the loader lock to be acquired again, causing a deadlock or a crash.</li>
<li>Call <a href="/en-us/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createthread" data-linktype="absolute-path"><strong>CreateThread</strong></a>. Creating a thread can work if you do not synchronize with other threads, but it is risky.</li>
<li>Create a named pipe or other named object (Windows 2000 only). In Windows 2000, named objects are provided by the Terminal Services DLL. If this DLL is not initialized, calls to the DLL can cause the process to crash.</li>
<li>Use the memory management function from the dynamic C Run-Time (CRT). If the CRT DLL is not initialized, calls to these functions can cause the process to crash.</li>
<li>Call functions in User32.dll or Gdi32.dll. Some functions load another DLL, which may not be initialized.</li>
<li>Use managed code.</li>
</ul>
<p>The following tasks are safe to perform within <strong>DllMain</strong>:</p>
<ul>
<li>Initialize static data structures and members at compile time.</li>
<li>Create and initialize synchronization objects.</li>
<li>Allocate memory and initialize dynamic data structures (avoiding the functions listed above.)</li>
<li>Set up thread local storage (TLS).</li>
<li>Open, read from, and write to files.</li>
<li>Call functions in Kernel32.dll (except the functions that are listed above).</li>
<li>Set global pointers to NULL, putting off the initialization of dynamic members. In Microsoft Windows Vista™, you can use the one-time initialization functions to ensure that a block of code is executed only once in a multithreaded environment.</li>
</ul>
<h2 id="deadlocks-caused-by-lock-order-inversion">Deadlocks Caused by Lock Order Inversion</h2>
<p>When you are implementing code that uses multiple synchronization objects such as locks, it is vital to respect lock order. When it is necessary to acquire more than one lock at a time, you must define an explicit precedence that is called a lock hierarchy or lock order. For example, if lock A is acquired before lock B somewhere in the code, and lock B is acquired before lock C elsewhere in the code, then the lock order is A, B, C and this order should be followed throughout the code. Lock order inversion occurs when the locking order is not followed—for example, if lock B is acquired before lock A. Lock order inversion can cause deadlocks that are difficult to debug. To avoid such problems, all threads must acquire locks in the same order.</p>
<p>It is important to note that the loader calls <a href="dllmain" data-linktype="relative-path"><strong>DllMain</strong></a> with the loader lock already acquired, so the loader lock should have the highest precedence in the locking hierarchy. Also note that code only has to acquire the locks it requires for proper synchronization; it does not have to acquire every single lock that is defined in the hierarchy. For example, if a section of code requires only locks A and C for proper synchronization, then the code should acquire lock A before it acquires lock C; it is not necessary for the code to also acquire lock B. Furthermore, DLL code cannot explicitly acquire the loader lock. If the code must call an API such as <a href="/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getmodulefilenamea" data-linktype="absolute-path"><strong>GetModuleFileName</strong></a> that can indirectly acquire the loader lock and the code must also acquire a private lock, then the code should call <strong>GetModuleFileName</strong> before it acquires lock P, thus ensuring that load order is respected.</p>
<p>Figure 2 is an example that illustrates lock order inversion. Consider a DLL whose main thread contains <a href="dllmain" data-linktype="relative-path"><strong>DllMain</strong></a>. The library loader acquires the loader lock L and then calls into <strong>DllMain</strong>. The main thread creates synchronization objects A, B, and G to serialize access to its data structures and then tries to acquire lock G. A worker thread that has already successfully acquired lock G then calls a function such as GetModuleHandle that attempts to acquire the loader lock L. Thus, the worker thread is blocked on L and the main thread is blocked on G, resulting in a deadlock.</p>
<p><img src="images/fig2.png" alt="deadlock caused by lock order inversion" data-linktype="relative-path"/></p>
<p>To prevent deadlocks that are caused by lock order inversion, all threads should attempt to acquire synchronization objects in the defined load order at all times.</p>
<h2 id="best-practices-for-synchronization">Best Practices for Synchronization</h2>
<p>Consider a DLL that creates worker threads as part of its initialization. Upon DLL cleanup, it is necessary to synchronize with all the worker threads to ensure that the data structures are in a consistent state and then terminate the worker threads. Today, there is no straightforward way to completely solve the problem of cleanly synchronizing and shutting down DLLs in a multithreaded environment. This section describes the current best practices for thread synchronizing during DLL shutdown.</p>
<p>Thread Synchronization in <a href="dllmain" data-linktype="relative-path"><strong>DllMain</strong></a> during Process Exit</p>
<ul>
<li>By the time <a href="dllmain" data-linktype="relative-path"><strong>DllMain</strong></a> is called at process exit, all the process’s threads have been forcibly cleaned up and there is a chance that the address space is inconsistent. Synchronization is not required in this case. In other words, the ideal DLL_PROCESS_DETACH handler is empty.</li>
<li>Windows Vista ensures that core data structures (environment variables, current directory, process heap, and so on) are in a consistent state. However, other data structures can be corrupted, so cleaning memory is not safe.</li>
<li>Persistent state that needs to be saved must be flushed to permanent storage.</li>
</ul>
<p>Thread Synchronization in <strong>DllMain</strong> for DLL_THREAD_DETACH during DLL Unload</p>
<ul>
<li>When the DLL is unloaded, the address space is not thrown away. Therefore, the DLL is expected to perform a clean shutdown. This includes thread synchronization, open handles, persistent state, and allocated resources.</li>
<li>Thread synchronization is tricky because waiting on threads to exit in <a href="dllmain" data-linktype="relative-path"><strong>DllMain</strong></a> can cause a deadlock. For example, DLL A holds the loader lock. It signals thread T to exit and waits for the thread to exit. Thread T exits and the loader tries to acquire the loader lock to call into DLL A’s <strong>DllMain</strong> with DLL_THREAD_DETACH. This causes a deadlock. To minimize the risk of a deadlock:
<ul>
<li>DLL A gets a DLL_THREAD_DETACH message in its <a href="dllmain" data-linktype="relative-path"><strong>DllMain</strong></a> and sets an event for thread T, signaling it to exit.</li>
<li>Thread T finishes its current task, brings itself to a consistent state, signals DLL A, and waits infinitely. Note that the consistency-checking routines should follow the same restrictions as <a href="dllmain" data-linktype="relative-path"><strong>DllMain</strong></a> to avoid deadlocking.</li>
<li>DLL A terminates T, knowing that it is in a consistent state.</li>
</ul>
</li>
</ul>
<p>If a DLL is unloaded after all its threads have been created, but before they begin executing, the threads may crash. If the DLL created threads in its <strong>DllMain</strong> as part of its initialization, some threads may not have finished initialization and their DLL_THREAD_ATTACH message is still waiting to be delivered to the DLL. In this situation, if the DLL is unloaded, it will begin terminating threads. However, some threads may be blocked behind the loader lock. Their DLL_THREAD_ATTACH messages are processed after the DLL has been unmapped, causing the process to crash.</p>
<h2 id="recommendations">Recommendations</h2>
<p>The following are recommended guidelines:</p>
<ul>
<li>Use Application Verifier to catch the most common errors in <a href="dllmain" data-linktype="relative-path"><strong>DllMain</strong></a>.</li>
<li>If using a private lock inside <a href="dllmain" data-linktype="relative-path"><strong>DllMain</strong></a>, define a locking hierarchy and use it consistently. The loader lock must be at the bottom of this hierarchy.</li>
<li>Verify that no calls depend on another DLL that may not have been fully loaded yet.</li>
<li>Perform simple initializations statically at compile time, rather than in <a href="dllmain" data-linktype="relative-path"><strong>DllMain</strong></a>.</li>
<li>Defer any calls in <a href="dllmain" data-linktype="relative-path"><strong>DllMain</strong></a> that can wait until later.</li>
<li>Defer initialization tasks that can wait until later. Certain error conditions must be detected early so that the application can handle errors gracefully. However, there are tradeoffs between this early detection and the loss of robustness that can result from it. Deferring initialization is often best.</li>
</ul>
<p> </p>
<p> </p>

						<!-- </content> -->

						</main>

						<!-- page rating section -->
								<div class="is-hidden-desktop has-border-top has-margin-top-large has-padding-top-small">
									
									
<div class="feedback-verbatim has-border-bottom has-padding-bottom-small has-margin-bottom-small" data-bi-name="rating">
    <div class="binary-rating">
        <div class="binary-rating-buttons">
            <h3 class="has-text-weight-semibold has-margin-top-none has-margin-bottom-small">此页面有帮助吗?</h3>
            <div>
                <button class="thumb-rating like has-inner-focus has-padding-left-extra-small has-padding-right-extra-small" title="是" data-bi-name="rating-yes" aria-expanded="false" data-bi-sat="1" aria-controls="rating-container-mobile">
                    <span aria-hidden="true" class="icon docon docon-like"></span>
                    <span>是</span>
                </button>
                <button class="thumb-rating dislike has-inner-focus has-padding-none has-padding-right-extra-small" title="否" data-bi-name="rating-no" data-bi-sat="0" aria-expanded="false" aria-controls="rating-container-mobile">
                    <span aria-hidden="true" class="icon docon docon-dislike"></span>
                    <span>否</span>
                </button>
            </div>
        </div>
        <form class="feedback-verbatim-form is-hidden" id="rating-container-mobile">
            <div class="verbatim-textarea box is-relative has-box-shadow-none has-border has-margin-top-small has-padding-extra-small is-size-extra-small">
                <label for="rating-textarea-mobile" class="visually-hidden">还有其他反馈吗？</label>
                <textarea id="rating-textarea-mobile" rows="4" maxlength="999" placeholder="还有其他反馈吗？" required class="textarea has-border-none has-box-shadow-none has-inner-focus"></textarea>
            </div>
            <div class="buttons is-right has-margin-top-medium has-margin-right-extra-small">
                <button class="skip-rating button is-transparent has-text-primary is-small has-border-none" type="button">跳过</button>
                <button class="submit-rating button is-primary is-small" data-bi-name="rating-verbatim" disabled type="submit">提交</button>
            </div>
        </form>
    </div>
    <div class="thankyou-rating is-hidden" tabindex="-1">
        <p>谢谢。</p>
    </div>
</div>								</div>
						<!-- end page rating section -->


						<!-- recommendations section -->
						<!-- end recommendations section -->

						<!-- feedback section -->
						<!-- end feedback section -->

						<!-- feedback report section -->
						<!-- end feedback report section -->

						<div class="footerContainer is-visible-interactive has-default-focus ">



	<footer id="footer-interactive" data-bi-name="footer" class="footer-layout">

    <div class="is-flex is-full-height has-padding-right-extra-large-desktop">
			<a data-mscc-ic="false" class="locale-selector-link has-flex-shrink-none" href="#" data-bi-name="select-locale"><span class="icon docon docon-world is-size-large has-margin-right-small" aria-hidden="true"></span><span class="local-selector-link-text"></span></a>
		<div class="has-margin-left-medium has-margin-right-medium has-flex-shrink-none">
<div class="dropdown has-caret-up">
	<button class="dropdown-trigger button is-transparent is-small is-icon-only-touch has-inner-focus theme-dropdown-trigger"
		aria-controls="theme-menu-interactive" aria-expanded="false" title="主题" data-bi-name="theme">
		<span class="icon">
			<span class="docon docon-sun" aria-hidden="true"></span>
		</span>
		<span>主题</span>
	</button>
	<div class="dropdown-menu" id="theme-menu-interactive" role="menu">
		<ul class="theme-selector has-padding-small">
			<li class="theme is-block">
				<button class="button is-text is-small theme-control is-fullwidth has-flex-justify-content-start"
					data-theme-to="light">
					<span class="theme-light has-margin-right-small">
						<span
							class="theme-selector-icon css-variable-support has-border is-inline-block has-body-background"
							aria-hidden="true">
							<svg class="svg" xmlns="http://www.w3.org/2000/svg"
								viewBox="0 0 22 14">
								<rect width="22" height="14" class="has-fill-body-background" />
								<rect x="5" y="5" width="12" height="4" class="has-fill-secondary" />
								<rect x="5" y="2" width="2" height="1" class="has-fill-secondary" />
								<rect x="8" y="2" width="2" height="1" class="has-fill-secondary" />
								<rect x="11" y="2" width="3" height="1" class="has-fill-secondary" />
								<rect x="1" y="1" width="2" height="2" class="has-fill-secondary" />
								<rect x="5" y="10" width="7" height="2" rx="0.3" class="has-fill-primary" />
								<rect x="19" y="1" width="2" height="2" rx="1" class="has-fill-secondary" />
							</svg>
						</span>
					</span>
					<span role="menuitem">
亮					</span>
				</button>
			</li>
			<li class="theme is-block">
				<button class="button is-text is-small theme-control is-fullwidth has-flex-justify-content-start"
					data-theme-to="dark">
					<span class="theme-dark has-margin-right-small">
						<span
							class="has-border theme-selector-icon css-variable-support is-inline-block has-body-background"
							aria-hidden="true">
							<svg class="svg" xmlns="http://www.w3.org/2000/svg"
								viewBox="0 0 22 14">
								<rect width="22" height="14" class="has-fill-body-background" />
								<rect x="5" y="5" width="12" height="4" class="has-fill-secondary" />
								<rect x="5" y="2" width="2" height="1" class="has-fill-secondary" />
								<rect x="8" y="2" width="2" height="1" class="has-fill-secondary" />
								<rect x="11" y="2" width="3" height="1" class="has-fill-secondary" />
								<rect x="1" y="1" width="2" height="2" class="has-fill-secondary" />
								<rect x="5" y="10" width="7" height="2" rx="0.3" class="has-fill-primary" />
								<rect x="19" y="1" width="2" height="2" rx="1" class="has-fill-secondary" />
							</svg>
						</span>
					</span>
					<span role="menuitem">
暗					</span>
				</button>
			</li>
			<li class="theme is-block">
				<button class="button is-text is-small theme-control is-fullwidth has-flex-justify-content-start"
					data-theme-to="high-contrast">
					<span class="theme-high-contrast has-margin-right-small">
						<span
							class="has-border theme-selector-icon css-variable-support is-inline-block has-body-background"
							aria-hidden="true">
							<svg class="svg" xmlns="http://www.w3.org/2000/svg"
								viewBox="0 0 22 14">
								<rect width="22" height="14" class="has-fill-body-background" />
								<rect x="5" y="5" width="12" height="4" class="has-fill-secondary" />
								<rect x="5" y="2" width="2" height="1" class="has-fill-secondary" />
								<rect x="8" y="2" width="2" height="1" class="has-fill-secondary" />
								<rect x="11" y="2" width="3" height="1" class="has-fill-secondary" />
								<rect x="1" y="1" width="2" height="2" class="has-fill-secondary" />
								<rect x="5" y="10" width="7" height="2" rx="0.3" class="has-fill-primary" />
								<rect x="19" y="1" width="2" height="2" rx="1" class="has-fill-secondary" />
							</svg>
						</span>
					</span>
					<span role="menuitem">
高对比度					</span>
				</button>
			</li>
		</ul>
	</div>
</div>		</div>
	</div>
    <ul class="links" data-bi-name="footerlinks">
		<li class="manage-cookies-holder" hidden></li>
			<li><a data-mscc-ic="false" href="https://docs.microsoft.com/zh-cn/previous-versions/" data-bi-name="archivelink">旧版文档</a></li>
			<li><a data-mscc-ic="false" href="https://docs.microsoft.com/zh-cn/teamblog" data-bi-name="bloglink">博客</a></li>
			<li><a data-mscc-ic="false" href="https://docs.microsoft.com/zh-cn/contribute" data-bi-name="contributorGuide">参与</a></li>
				<li><a data-mscc-ic="false" href="https://go.microsoft.com/fwlink/?LinkId=521839" data-bi-name="privacy">隐私和 Cookie</a></li>
			<li><a data-mscc-ic="false" href="https://docs.microsoft.com/zh-cn/legal/termsofuse" data-bi-name="termsofuse">使用条款</a></li>
				<li><a data-mscc-ic="false" href="https://aka.ms/sitefeedback" data-bi-name="feedback">网站反馈</a></li>
			<li><a data-mscc-ic="false" href="https://www.microsoft.com/en-us/legal/intellectualproperty/Trademarks/EN-US.aspx" data-bi-name="trademarks">商标</a></li>
		<li>&copy; Microsoft 2020</li>
    </ul>
</footer>
						</div>
					</div>

					<div class="is-size-small right-container column is-one-quarter is-one-fifth-desktop is-hidden-mobile is-hidden-tablet-only" data-bi-name="pageactions" role="complementary" aria-label="页面操作">
						<div id="affixed-right-container" class="doc-outline is-fixed is-vertically-scrollable">
								
								
<div class="feedback-verbatim has-border-bottom has-padding-bottom-small has-margin-bottom-small" data-bi-name="rating">
    <div class="binary-rating">
        <div class="binary-rating-buttons">
            <h3 class="has-text-weight-semibold has-margin-top-none has-margin-bottom-small">此页面有帮助吗?</h3>
            <div>
                <button class="thumb-rating like has-inner-focus has-padding-left-extra-small has-padding-right-extra-small" title="是" data-bi-name="rating-yes" aria-expanded="false" data-bi-sat="1" aria-controls="rating-container-desktop">
                    <span aria-hidden="true" class="icon docon docon-like"></span>
                    <span>是</span>
                </button>
                <button class="thumb-rating dislike has-inner-focus has-padding-none has-padding-right-extra-small" title="否" data-bi-name="rating-no" data-bi-sat="0" aria-expanded="false" aria-controls="rating-container-desktop">
                    <span aria-hidden="true" class="icon docon docon-dislike"></span>
                    <span>否</span>
                </button>
            </div>
        </div>
        <form class="feedback-verbatim-form is-hidden" id="rating-container-desktop">
            <div class="verbatim-textarea box is-relative has-box-shadow-none has-border has-margin-top-small has-padding-extra-small is-size-extra-small">
                <label for="rating-textarea-desktop" class="visually-hidden">还有其他反馈吗？</label>
                <textarea id="rating-textarea-desktop" rows="4" maxlength="999" placeholder="还有其他反馈吗？" required class="textarea has-border-none has-box-shadow-none has-inner-focus"></textarea>
            </div>
            <div class="buttons is-right has-margin-top-medium has-margin-right-extra-small">
                <button class="skip-rating button is-transparent has-text-primary is-small has-border-none" type="button">跳过</button>
                <button class="submit-rating button is-primary is-small" data-bi-name="rating-verbatim" disabled type="submit">提交</button>
            </div>
        </form>
    </div>
    <div class="thankyou-rating is-hidden" tabindex="-1">
        <p>谢谢。</p>
    </div>
</div>							<nav id="side-doc-outline" data-bi-name="intopic toc" role="navigation" aria-label="文章大纲">
								<h3>本文内容</h3>
							</nav>
						</div>
					</div>

					<!--end of div.columns -->
				</div>

			<!--end of .primary-holder -->
			</section>

			<aside id="interactive-container" class="interactive-container is-visible-interactive column has-body-background-dark ">
			</aside>
		</div>

		<!--end of .mainContainer -->
	</div>

	<div id="openFeedbackContainer" class="openfeedback-container"></div>

	<div class="footerContainer has-default-focus is-hidden-interactive ">



	<footer id="footer" data-bi-name="footer" class="footer-layout uhf-container has-padding" role="contentinfo">

    <div class="is-flex is-full-height has-padding-right-extra-large-desktop">
			<a data-mscc-ic="false" class="locale-selector-link has-flex-shrink-none" href="#" data-bi-name="select-locale"><span class="icon docon docon-world is-size-large has-margin-right-small" aria-hidden="true"></span><span class="local-selector-link-text"></span></a>
		<div class="has-margin-left-medium has-margin-right-medium has-flex-shrink-none">
<div class="dropdown has-caret-up">
	<button class="dropdown-trigger button is-transparent is-small is-icon-only-touch has-inner-focus theme-dropdown-trigger"
		aria-controls="theme-menu" aria-expanded="false" title="主题" data-bi-name="theme">
		<span class="icon">
			<span class="docon docon-sun" aria-hidden="true"></span>
		</span>
		<span>主题</span>
	</button>
	<div class="dropdown-menu" id="theme-menu" role="menu">
		<ul class="theme-selector has-padding-small">
			<li class="theme is-block">
				<button class="button is-text is-small theme-control is-fullwidth has-flex-justify-content-start"
					data-theme-to="light">
					<span class="theme-light has-margin-right-small">
						<span
							class="theme-selector-icon css-variable-support has-border is-inline-block has-body-background"
							aria-hidden="true">
							<svg class="svg" xmlns="http://www.w3.org/2000/svg"
								viewBox="0 0 22 14">
								<rect width="22" height="14" class="has-fill-body-background" />
								<rect x="5" y="5" width="12" height="4" class="has-fill-secondary" />
								<rect x="5" y="2" width="2" height="1" class="has-fill-secondary" />
								<rect x="8" y="2" width="2" height="1" class="has-fill-secondary" />
								<rect x="11" y="2" width="3" height="1" class="has-fill-secondary" />
								<rect x="1" y="1" width="2" height="2" class="has-fill-secondary" />
								<rect x="5" y="10" width="7" height="2" rx="0.3" class="has-fill-primary" />
								<rect x="19" y="1" width="2" height="2" rx="1" class="has-fill-secondary" />
							</svg>
						</span>
					</span>
					<span role="menuitem">
亮					</span>
				</button>
			</li>
			<li class="theme is-block">
				<button class="button is-text is-small theme-control is-fullwidth has-flex-justify-content-start"
					data-theme-to="dark">
					<span class="theme-dark has-margin-right-small">
						<span
							class="has-border theme-selector-icon css-variable-support is-inline-block has-body-background"
							aria-hidden="true">
							<svg class="svg" xmlns="http://www.w3.org/2000/svg"
								viewBox="0 0 22 14">
								<rect width="22" height="14" class="has-fill-body-background" />
								<rect x="5" y="5" width="12" height="4" class="has-fill-secondary" />
								<rect x="5" y="2" width="2" height="1" class="has-fill-secondary" />
								<rect x="8" y="2" width="2" height="1" class="has-fill-secondary" />
								<rect x="11" y="2" width="3" height="1" class="has-fill-secondary" />
								<rect x="1" y="1" width="2" height="2" class="has-fill-secondary" />
								<rect x="5" y="10" width="7" height="2" rx="0.3" class="has-fill-primary" />
								<rect x="19" y="1" width="2" height="2" rx="1" class="has-fill-secondary" />
							</svg>
						</span>
					</span>
					<span role="menuitem">
暗					</span>
				</button>
			</li>
			<li class="theme is-block">
				<button class="button is-text is-small theme-control is-fullwidth has-flex-justify-content-start"
					data-theme-to="high-contrast">
					<span class="theme-high-contrast has-margin-right-small">
						<span
							class="has-border theme-selector-icon css-variable-support is-inline-block has-body-background"
							aria-hidden="true">
							<svg class="svg" xmlns="http://www.w3.org/2000/svg"
								viewBox="0 0 22 14">
								<rect width="22" height="14" class="has-fill-body-background" />
								<rect x="5" y="5" width="12" height="4" class="has-fill-secondary" />
								<rect x="5" y="2" width="2" height="1" class="has-fill-secondary" />
								<rect x="8" y="2" width="2" height="1" class="has-fill-secondary" />
								<rect x="11" y="2" width="3" height="1" class="has-fill-secondary" />
								<rect x="1" y="1" width="2" height="2" class="has-fill-secondary" />
								<rect x="5" y="10" width="7" height="2" rx="0.3" class="has-fill-primary" />
								<rect x="19" y="1" width="2" height="2" rx="1" class="has-fill-secondary" />
							</svg>
						</span>
					</span>
					<span role="menuitem">
高对比度					</span>
				</button>
			</li>
		</ul>
	</div>
</div>		</div>
	</div>
    <ul class="links" data-bi-name="footerlinks">
		<li class="manage-cookies-holder" hidden></li>
			<li><a data-mscc-ic="false" href="https://docs.microsoft.com/zh-cn/previous-versions/" data-bi-name="archivelink">旧版文档</a></li>
			<li><a data-mscc-ic="false" href="https://docs.microsoft.com/zh-cn/teamblog" data-bi-name="bloglink">博客</a></li>
			<li><a data-mscc-ic="false" href="https://docs.microsoft.com/zh-cn/contribute" data-bi-name="contributorGuide">参与</a></li>
				<li><a data-mscc-ic="false" href="https://go.microsoft.com/fwlink/?LinkId=521839" data-bi-name="privacy">隐私和 Cookie</a></li>
			<li><a data-mscc-ic="false" href="https://docs.microsoft.com/zh-cn/legal/termsofuse" data-bi-name="termsofuse">使用条款</a></li>
				<li><a data-mscc-ic="false" href="https://aka.ms/sitefeedback" data-bi-name="feedback">网站反馈</a></li>
			<li><a data-mscc-ic="false" href="https://www.microsoft.com/en-us/legal/intellectualproperty/Trademarks/EN-US.aspx" data-bi-name="trademarks">商标</a></li>
		<li>&copy; Microsoft 2020</li>
    </ul>
</footer>
	</div>

	<div id="action-panel" role="region" aria-label="操作面板" class="action-panel has-default-focus" tabindex="-1"></div>
	<span id="adobe-target-experiment-container" hidden></span>
</body>
</html>
