<!DOCTYPE HTML>
<html>
    <script>
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?d88c3d2ca47e455c320ae7d951a8d0ca";
          var s = document.getElementsByTagName("script")[0]; 
          s.parentNode.insertBefore(hm, s);
        })();
    </script>
    <head>
        <title>公式王 公式图片转Word格式</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
        <meta content="width=device-width, minimum-scale=1.0,maximum-scale=1, initial-scale=1, user-scalable=no" name="viewport" servergenerated="true"/>
        <!-- 忽略页面中的数字识别为电话，忽略email识别 -->
        <meta content="telephone=no,email=no" name="format-detection">
        <!-- 不让百度转码 -->
        <meta http-equiv="Cache-Control" content="no-siteapp">
        <!-- WebApp全屏模式：伪装app，离线应用。 -->
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta content="yes" name="apple-touch-fullscreen">

        <meta name="apple-mobile-web-app-status-bar-style" content="black" />
        <!-- 浏览器内核控制 webkit内核高速浏览 -->
        <meta name="renderer" content="webkit" />
        <!--<meta name="full-screen"content="yes">-->
        <meta name="screen-orientation" content="portrait">
        <!--<meta name="x5-fullscreen"content="true">-->
        <meta name="x5-orientation" content="portrait">

        <!-- 页面描述:content不超过150个字符 -->
        <meta name="description" content="">
        <meta name="keywords" content="" />
        <meta name="baidu_union_verify" content="b2a75ec0d9ce1dfe4fb37a9a4df8d6cd">
        <style type="text/css">
            body {
                text-align: center;
            }
            #logo-default {
                background-image: url(static/gongshiwang250.png);
                background-repeat: no-repeat;
                margin-bottom: 20px;
                height: 64px;
                display: inline-block;
                width: 250px;
            }
            .container {
                position: relative;
                display: inline-block;
                margin-top: 30px;
                width: 500px;
            }
            .selector {
                position: relative;
                height: 150px;
                border: 3px solid #ccc;
                /* line-height: 300px; */
                /* text-align: center; */
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .button {
                display: inline-block;
                padding: 8px 16px;
                border-radius: 5px;
                background-color: #4CAF50;
                color: #fff;
                text-decoration: none;
                border-width: 0px;
                margin-bottom: 20px;
                transition: all .3s;
            }
            .buttongray {
                background-color: #e7e7e7; /* Green */
                border: none;
                color: #555555;
                padding: 15px 32px;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 16px;
            }
            #resulttextlatex {
                margin-top: 20px;
                position: relative;
                width: 494px;
                height: 30px;
                border: 3px solid #ccc;
                text-align: left;
            }
            #resulttextmml {
                margin-top: 20px;
                position: relative;
                width: 494px;
                height: 30px;
                border: 3px solid #ccc;
                text-align: left;
            }
            .buttoncss {
                text-align: right;
            }
            #ocrresult {
                margin-top: 20px;
                /* height: 50px;
                border: 3px solid #ccc; */
            }
            [name="file"] {
                position: absolute;
                top: 0;
                left: 0;
                z-index: 2;
                width: 100%;
                height: 100%;
                opacity: 0;
            }
            img {
                max-width: 100%;
                max-height: 100%;
            }
            .zanshang {
                position: relative;
                margin-top: 50px;        
            }
            #tip {
                position: relative;
                z-index: 1;
                color: #ccc;
            }
            /* .over {
                display: none;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: #f5f5f5;
                opacity:0.5;
                z-index: 1000;
            }
            .layout {
                
                display: none;
                position: absolute;
                top: 40%;
                left: 40%;
                width: 20%;
                height: 20%;
                z-index: 1001;
                text-align:center;
            } */
        </style>
    </head>
    <body>
        <div class="container">
            <div id="logo-default"></div>
            <div class="selector">
                <input id="file" type="file" name="file">
                <img id="img" src="" alt="">
                <span id="tip">请选择本地图片或粘贴图片</span>
            </div>
            <!-- <div id="ocrresult">
    
            </div> -->
            <div>
                <div>
                    <textarea id="resulttextlatex" placeholder="Latex格式的公式拷贝后，直接粘贴到WPS、马克飞象、简书等编辑器中"></textarea>
                </div>
                <div class="buttoncss">
                    <button class="button" id="latexButton" data-clipboard-target="#resulttextlatex" data-clipboard-ac>拷贝laTex</button>
                </div>
            </div>
            <div>
                <div>
                    <textarea id="resulttextmml" placeholder="MathML格式的公式拷贝后，直接粘贴到Word文档中"></textarea>
                </div>
                <div class="buttoncss">
                    <button class="button" id="mmlButton" data-clipboard-target="#resulttextmml" data-clipboard-ac>拷贝MathML</button>
                </div>
            </div>
        </div>
        <div id="donate" class="zanshang"></div>
        <!-- <div class="zanshang" align="center">
            <script type="text/javascript">var jd_union_pid="3002664051";var jd_union_euid="";</script><script type="text/javascript" src="//ads-union.jd.com/static/js/union.js"></script>
            <script type="text/javascript">var jd_union_pid="3002660154";var jd_union_euid="";</script><script type="text/javascript" src="//ads-union.jd.com/static/js/union.js"></script> 
        </div> -->
        <!-- <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script> -->
        <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
        <script src="https://cdn.bootcdn.net/ajax/libs/zepto/1.2.0/zepto.min.js"></script>
        <script src="https://cdn.bootcdn.net/ajax/libs/mathjax/3.0.5/es5/tex-svg.js"></script>
        <script src="static/vdonate.js"></script>
        <script>
            //初始化ClipboardJS.
            new ClipboardJS('.button');

            new vdonate({
                title: "如果节省了你一点点时间，就直白的赞赏一下吧",
                el: document.getElementById("donate"),
                btnText: "赞赏",
                wechatImage: "static/wechat200.png",
                alipayImage: "static/alipay200.png"
            });


            //最大文件大小2M
            var maxFileSize = 1024*1024*2;
            var input = document.getElementById('file');
            var tip = document.getElementById('tip');
            var img = document.getElementById('img');
            var resultPanelLatex = document.getElementById('resulttextlatex');
            var resultPanelMml = document.getElementById('resulttextmml');
            input.addEventListener('change', function(e){
                loadPictrue((e.target || e.srcElement).files[0]);
            });
            setPasteImg();
            //获取粘贴板上的图片
            function setPasteImg(){
                //粘贴事件
                document.addEventListener('paste', function(event){
                    if (event.clipboardData || event.originalEvent) {
                        var clipboardData = (event.clipboardData || event.originalEvent.clipboardData);
                        if(clipboardData.items){
                            var blob;
                            for (var i = 0; i < clipboardData.items.length; i++) {
                                if (clipboardData.items[i].type.indexOf("image") !== -1) {
                                    blob = clipboardData.items[i].getAsFile();
                                }
                            }
                            loadPictrue(blob);
                        }
                    }
                })
            }
            // 加载图片
            function loadPictrue(blob) {
                //禁止上传大于2M的图片
                if(blob.size > maxFileSize){
                    Toast("请上传小于2M的图片", 3000);
                    return;
                }
                var render = new FileReader();
                render.onload = function (evt) {
                    //输出base64编码
                    var base64 = evt.target.result;
                    tip.style.display = 'none';
                    img.setAttribute('src', base64);
                }
                render.readAsDataURL(blob);
                requestOcr(blob);
            }

            
            function Toast(msg, duration) {
                duration = isNaN(duration) ? 3000 : duration;
                var m = document.createElement('div');
                m.innerHTML = msg;
                m.style.cssText = "font-family:siyuan;max-width:60%;min-width: 150px;padding:0 14px;height: 40px;color: rgb(255, 255, 255);line-height: 40px;text-align: center;border-radius: 4px;position: fixed;top: 50%;left: 50%;transform: translate(-50%, -50%);z-index: 999999;background: rgba(0, 0, 0,.7);font-size: 16px;";
                document.body.appendChild(m);
                setTimeout(function() {
                    var d = 0.5;
                    m.style.webkitTransition = '-webkit-transform ' + d + 's ease-in, opacity ' + d + 's ease-in';
                    m.style.opacity = '0';
                    setTimeout(function() {
                        document.body.removeChild(m)
                    }, d * 1000);
                }, duration);
            }

            function requestOcr(blob){
                var formData = new FormData();
                formData.append('file', blob);
                $.ajax({
                    type: 'post',
                    url: '/upload',
                    data: formData,
                    processData: false,
                    contentType: false,
                    beforeSend: function() {
                        showLoading();
                    },
                    success: function(res) {
                        if(res.latex_styled != null && res.latex_styled !=undefined){
                            resultPanelLatex.innerText = res.latex_styled;
                            convert2mml();
                        }
                        else{
                            resultPanelLatex.innerText = "公式王只支持图片公式和手写公式识别";
                            resultPanelMml.innerText = "公式王只支持图片公式和手写公式识别";
                        }
                        // convert();
                        completeLoading();
                    },
                    error: function(err) {
                        if(err.status == 429){
                            Toast("操作太快，请稍候再试", 3000)
                        }
                        if(err.status == 1003){
                            Toast("公式王只支持图片公式和手写公式识别", 3000)
                        }
                        // Toast(err.innerHTML, 2000)
                        completeLoading();
                        console.log(err)
                    }
                })
            }

            function convert2mml() {
                var input = document.getElementById("resulttextlatex").value.trim();

                MathJax.tex2mmlPromise(input).then(function (mml) {
                    resultPanelMml.innerText = mml;
                }).catch(function (err) {
                    //
                    //  If there was an error, put the message into the output instead
                    //
                }).then(function () {

                });
            }
            var _LoadingHtml = '<div id="loadingDiv" style="display: none; "><div id="over" style=" position: absolute;top: 0;left: 0; width: 100%;height: 100%; background-color: #f5f5f5;opacity:0.5;z-index: 1000;"></div><div id="layout" style="position: absolute;top: 40%; left: 40%;width: 20%; height: 20%;  z-index: 1001;text-align:center;"><img src="static/loading.gif" /></div></div>';
            document.write(_LoadingHtml);

            function showLoading(){
                document.getElementById("loadingDiv").style.display="block";
            }
            
            function completeLoading() {  
                document.getElementById("loadingDiv").style.display="none";
            }
        </script>
    </body>
</html>