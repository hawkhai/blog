<!DOCTYPE html>
<html>

    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="dns-prefetch" href="//cdn.bootcss.com" />

    <title>Hawkhai | 开发环境 -- 搭建 Windows Jekyll 环境</title>
    <meta name="description" content="Windows 搭建 Jekyll 环境。bundle install 的时候，libv8 和 therubyracer 会失败，主要是工程配置和源代码 Windows 平台的兼容性么有做好。">

    <link rel="shortcut icon" type="image/png" href="/favicon.png" />

    <link rel="stylesheet" href="/css/main.css" />
    <link rel="canonical" href="https://blog.hawkhai.com/blog/2020/08/29/win-jekyll-install" />
    <link rel="alternate" type="application/rss+xml" title="Hawkhai" href="https://blog.hawkhai.com/feed.xml" />

    <link rel='stylesheet' href='/css/scope-one.css' />

    <link rel='stylesheet' href='/assets/syntax.css' />

    <link rel="stylesheet" href="/css/font-awesome.min.css" />
    <script src="/assets/jquery-3.5.1.min.js"></script>


</head>


<body>
  <div class="page">
    <header class="site-header">
    <a class="site-title" href="/">Hawkhai</a>
    <nav class="site-nav">
        <a href="#" class="menu-icon menu.open">
            <object type="image/svg+xml" data="/assets/menu.open.svg" >
            </object>
        </a>
        <div class="trigger"><h1>Main Navigation</h1>
            <ul class="menu">
    
    
    <li><a href="/invisible/" class="page-link">invisible</a>
    
    </li>
    
    
    <li><a href="/bookshelf/" class="page-link">书架</a>
    
    </li>
    
    
    <li><a href="/tags/tag" class="page-link">标签</a>
    
    </li>
    
    
    <li><a href="/disclaimer/" class="page-link">免责声明</a>
    
    </li>
    
    
    <li><a href="/about/" class="page-link">关于</a>
    
    </li>
    
</ul>

        </div>
    </nav>
</header>


    <div class="post" id="postdiv">
    <header class="post-header">
    <h1>开发环境 -- 搭建 Windows Jekyll 环境</h1>
    <p class="post-meta">
        Posted on August 29, 2020  (珠海)
        <br/>
        <span>
            
                
                <a href="/tags/tag?#Prog Env"><code><nobr>Prog Env</nobr></code>&nbsp;</a>
            
                
                <a href="/tags/tag?#Jekyll"><code><nobr>Jekyll</nobr></code>&nbsp;</a>
            
        </span>
    </p>


    </header>


<div id="tocwrap">
<div id="tocdiv" class="esa-catalog" style="display:none;"></div>
</div>
<script type="text/javascript" src="/assets/toc.js"></script>



    <p>Windows 搭建 Jekyll 环境。<code class="language-plaintext highlighter-rouge">bundle install</code> 的时候，<code class="language-plaintext highlighter-rouge">libv8</code> 和 <code class="language-plaintext highlighter-rouge">therubyracer</code> 会失败，主要是工程配置和源代码 Windows 平台的兼容性么有做好。</p>

<figure class="highlight"><pre><code class="language-plaintext" data-lang="plaintext">Installing libv8 3.16.14.19 with native extensions
../src/objects.h: At global scope:
../src/objects.h:5252:44: error: left operand of shift expression '(-1 &lt;&lt; 3)' is negative [-fpermissive]
 5252 |   static const int kElementsKindMask = (-1 &lt;&lt; kElementsKindShift) &amp;
      |                                        ~~~~^~~~~~~~~~~~~~~~~~~~~~
../src/objects.h:7386:36: error: left operand of shift expression '(-8 &lt;&lt; 26)' is negative [-fpermissive]
 7386 |       (~kMaxCachedArrayIndexLength &lt;&lt; kArrayIndexHashLengthShift) |
      |       ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
make[1]: *** [tools/gyp/v8_base.target.x64.mk:197：/c/Ruby25-x64/lib/ruby/gems/2.5.0/gems/libv8-3.16.14.19/vendor/v8/out/x64.release/obj.target/v8_base/src/accessors.o] 错误 1
make[1]: 离开目录“/c/Ruby25-x64/lib/ruby/gems/2.5.0/gems/libv8-3.16.14.19/vendor/v8/out”
make: *** [Makefile:195：x64.release] 错误 2</code></pre></figure>

<p>在基于源码的编译构建过程中，代码是临时释放的，mk 配置也是临时释放的，对于编译不过的地方，即使修改了，也会被 bundle 覆盖回滚。后来把这些改动过的代码和配置都拷贝出来，用脚本不停的尝试写入替换对应的文件，最终编译链接成功。</p>

<div class="captioned-img align ">

    <a href="/images/win-jekyll/win-jekyll.png">
        <img src="/images/win-jekyll/win-jekyll.png" />
    </a>
    





</div>

<h2 id="安装-ruby--gem">安装 ruby &amp; gem</h2>

<p>从 <a href="https://rubyinstaller.org/downloads/">https://rubyinstaller.org/downloads/</a> 下载，Ruby+Devkit 2.5.8-1 (x64) rubyinstaller-devkit-2.5.8-1-x64.exe。
因为 github-pages depends on ruby (&gt;= 2.2, &lt; 2.6) x64-mingw32，安装 MSYS2，选择 <code class="language-plaintext highlighter-rouge">3 - MSYS2 and MINGW development toolchain</code>，安装完成要选择“运行”。</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">ruby <span class="nt">-v</span>
gem <span class="nt">-v</span></code></pre></figure>

<h2 id="安装-bundler">安装 bundler</h2>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">ridk <span class="nb">install
</span>gem <span class="nb">install </span>bundler <span class="c"># 安装 bundler</span>
gem <span class="nb">install </span>bundler:1.16.1
chcp 850 <span class="c"># 多语种 (MS-DOS Latin1)</span>
gem <span class="nb">install </span>jekyll <span class="c"># 安装 jekyll</span>
jekyll <span class="nt">-v</span></code></pre></figure>

<h2 id="工程-bundle-install">工程 bundle install</h2>

<p>libv8 构建不成功，therubyracer 也构建不成功。网上的办法都行不通。必须先装好 Python2 环境，如果是 Python3，要改环境变量 Path，还有 PYTHONPATH &amp; PYTHONHOME（也可能没有），否则 Python 报错：<code class="language-plaintext highlighter-rouge">No module named site</code>。</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">bundle <span class="nb">install</span> <span class="c"># Need python 2!!</span>
<span class="c"># https://qiita.com/south37/items/9a3269c28d9fba80f0b7</span>
<span class="c"># bundle config build.libv8 --with-system-v8</span>
<span class="c"># bundle config build.therubyracer --with-v8-dir=/usr/local/opt/v8-315/</span>
<span class="c"># 这个方法理论可行，没有成功。</span>
<span class="c"># 灵感来自于 https://issues.adblockplus.org/ticket/4950</span>
<span class="c"># gem install libv8 -v '3.16.14.19' -- --with-system-v8</span>
<span class="c"># gem install therubyracer -v '0.12.3' -- --with-system-v8</span></code></pre></figure>

<p><strong>最终方案：</strong></p>

<p>先构建一次，把所有影响构建的源代码和工程配置（mk 文件）都拷贝出来，改动点具体见 python 代码。platform-win32.cc 里面的 <code class="language-plaintext highlighter-rouge">localtime_s</code> 和 include/time.h 里面的冲突，改个新名字，等等。
然后写个脚本（libv8.gem.py），不停的尝试写入替换这些文件；同时开启构建，一旦构建系统创建 / 释放 / 修改了这几个文件，马上替换掉，最终就可以顺利完成构建了。</p>

<p>建议用 <a href="https://www.voidtools.com/zh-cn/">Everything</a> 把编译不过的问题文件找出来。</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1">#encoding=utf8
</span><span class="kn">import</span> <span class="nn">os</span><span class="p">,</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">readfile</span><span class="p">(</span><span class="n">fpath</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fin</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">copyfile</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">tpath</span><span class="p">):</span>
    <span class="n">fdata</span> <span class="o">=</span> <span class="n">readfile</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
    <span class="n">ftarget</span> <span class="o">=</span> <span class="n">readfile</span><span class="p">(</span><span class="n">tpath</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fdata</span> <span class="o">==</span> <span class="n">ftarget</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="n">fout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">tpath</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span>
    <span class="n">fout</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">fdata</span><span class="p">)</span>
    <span class="n">fout</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">True</span>

<span class="k">def</span> <span class="nf">fmain</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">tpath</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">fpath</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">_dir</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">fpath</span><span class="p">):</span>
            <span class="n">_fpath</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">_dir</span><span class="p">)</span>
            <span class="n">_tpath</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">tpath</span><span class="p">,</span> <span class="n">_dir</span><span class="p">)</span>
            <span class="n">fmain</span><span class="p">(</span><span class="n">_fpath</span><span class="p">,</span> <span class="n">_tpath</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># time.sleep(0.001)
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tpath</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">copyfile</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">tpath</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">fpath</span><span class="p">)</span>

<span class="c1"># libv8 编译不过的问题文件
</span><span class="k">def</span> <span class="nf">fmain_libv8</span><span class="p">():</span>
    <span class="c1"># CFLAGS_Release := -fpermissive
</span>    <span class="c1"># CFLAGS_Debug := -fpermissive
</span>    <span class="n">fpath</span> <span class="o">=</span> <span class="s">r"D:\kSource\blog\source\gyp"</span>
    <span class="n">tpath</span> <span class="o">=</span> <span class="s">r"C:\Ruby25-x64\lib\ruby\gems\2.5.0\gems\libv8-3.16.14.19\vendor\v8\out\tools\gyp"</span>
    <span class="n">fmain</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">tpath</span><span class="p">)</span>
    <span class="n">fpath</span> <span class="o">=</span> <span class="s">r"D:\kSource\blog\source\src"</span>
    <span class="n">tpath</span> <span class="o">=</span> <span class="s">r"C:\Ruby25-x64\lib\ruby\gems\2.5.0\gems\libv8-3.16.14.19\vendor\v8\out\src"</span>
    <span class="n">fmain</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">tpath</span><span class="p">)</span>

    <span class="c1"># localtime_s -&gt; localtime_sx
</span>    <span class="c1"># #pragma comment(lib, "winmm.lib")
</span>    <span class="n">fpath</span> <span class="o">=</span> <span class="s">r"D:\kSource\blog\source\libv8-therubyracer\platform-win32.cc"</span>
    <span class="n">tpath</span> <span class="o">=</span> <span class="s">r"C:\Ruby25-x64\lib\ruby\gems\2.5.0\gems\libv8-3.16.14.19\vendor\v8\src\platform-win32.cc"</span>
    <span class="n">fmain</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">tpath</span><span class="p">)</span>

<span class="c1"># therubyracer 编译不过的问题文件
</span><span class="k">def</span> <span class="nf">fmain_therubyracer</span><span class="p">():</span>
    <span class="c1"># remove command line option '-rdynamic'
</span>    <span class="c1"># LIBS =&gt; -lwinmm 新增。
</span>    <span class="n">fpath</span> <span class="o">=</span> <span class="s">r"D:\kSource\blog\source\libv8-therubyracer\Makefile"</span>
    <span class="n">tpath</span> <span class="o">=</span> <span class="s">r"C:\Ruby25-x64\lib\ruby\gems\2.5.0\gems\therubyracer-0.12.3\ext\v8\Makefile"</span>
    <span class="n">fmain</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">tpath</span><span class="p">)</span>

    <span class="c1"># Accessor access(get, set, data); -&gt; Accessor accessor(get, set, data);
</span>    <span class="n">fpath</span> <span class="o">=</span> <span class="s">r"D:\kSource\blog\source\libv8-therubyracer\object.cc"</span>
    <span class="n">tpath</span> <span class="o">=</span> <span class="s">r"C:\Ruby25-x64\lib\ruby\gems\2.5.0\gems\therubyracer-0.12.3\ext\v8\object.cc"</span>
    <span class="n">fmain</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">tpath</span><span class="p">)</span>

<span class="k">while</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">fmain_libv8</span><span class="p">()</span>
    <span class="n">fmain_therubyracer</span><span class="p">()</span></code></pre></figure>

<h2 id="先把-libv8-编译过再把-therubyracer-编译过">先把 libv8 编译过，再把 therubyracer 编译过</h2>

<div class="captioned-img align ">

    <a href="/images/win-jekyll/win-jekyll2.png">
        <img src="/images/win-jekyll/win-jekyll2.png" />
    </a>
    





</div>

<hr />

<font class="ref_snapshot">Reference snapshot, script generated automatically.</font>

<ul>
  <li>[1] <a href="/backup/2020-08-29-win-jekyll-install.md/qiita.com/b5b4e3a3.html">https://qiita.com/south37/items/9a3269c28d9fba80f0b7</a></li>
  <li>[2] <a href="/backup/2020-08-29-win-jekyll-install.md/issues.adblockplus.org/22c7acf3.html">https://issues.adblockplus.org/ticket/4950</a></li>
  <li>[3] <a href="/backup/2020-08-29-win-jekyll-install.md/www.voidtools.com/926bc440.html">https://www.voidtools.com/zh-cn/</a></li>
</ul>


    ---<br/>
<!-- https://shopify.dev/docs/themes/liquid/reference/filters/string-filters -->
<!-- https://github.com/jekyll/jekyll/issues/2491 -->
本文短链接：<a id="short_urlx" target="_blank" href="#"></a><br/>
<script type="text/javascript">
var shortPrex = "https://blog.hawkhai.com/t.htm?";
var shortSeed = "/blog/2020/08/29/win-jekyll-install";
</script>


    If you have any questions or feedback, please reach out <code>haihoing@qq.com</code>.


    <hr>
    <div style="text-align:center"><br/>
        自由转载-非商用-非衍生-保持署名（创意共享 3.0 许可证）
    </div>
</div>





<script type="text/javascript" src="/assets/md5.min.js"></script>
<script type="text/javascript" src="/assets/blog.js"></script>








    <footer class="site-footer">
    Hawkhai personal website and blog.<br/>
    Copyright (c) hawkhai, 2016-2020. All rights reserved.<br/>
    Powered by <a href="http://jekyllrb.com/">Jekyll</a>, <a href="https://www.netlify.com/">netlify.com</a>
    
     | <a href="https://github.com/hawkhai/hawkhai.github.io">GitHub</a>
    
    <br/>
    Sun &amp; Ocean · <a href="https://sunocean.life">WWW.SUNOCEAN.LIFE</a>
</footer>


  </div>
</body>

</html>
