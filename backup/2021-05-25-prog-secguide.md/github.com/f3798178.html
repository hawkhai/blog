---
title : 自动快照存档
---

* TIME: 2021-05-25 17:15:04
* URL: <https://github.com/preshing/junction>

-----

Skip to content

[ ](https://github.com/)

[ Sign up
](/join?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-
name%3E%2F%3Crepo-name%3E&source=header-repo)

  * Why GitHub? 

[Features →](/features)

    * [Mobile →](/mobile)
    * [Actions →](/features/actions)
    * [Codespaces →](/features/codespaces)
    * [Packages →](/features/packages)
    * [Security →](/features/security)
    * [Code review →](/features/code-review/)
    * [Project management →](/features/project-management/)
    * [Integrations →](/features/integrations)
    * [GitHub Sponsors →](/sponsors)
    * [Customer stories→](/customer-stories)

  * [Team](/team)
  * [Enterprise](/enterprise)
  * Explore 

    * [Explore GitHub →](/explore)

#### Learn and contribute

    * [Topics →](/topics)
    * [Collections →](/collections)
    * [Trending →](/trending)
    * [Learning Lab →](https://lab.github.com/)
    * [Open source guides →](https://opensource.guide)

#### Connect with others

    * [The ReadME Project →](https://github.com/readme)
    * [Events →](https://github.com/events)
    * [Community forum →](https://github.community)
    * [GitHub Education →](https://education.github.com)
    * [GitHub Stars program →](https://stars.github.com)

  * [Marketplace](/marketplace)
  * Pricing 

[Plans →](/pricing)

    * [Compare plans →](/pricing#feature-comparison)
    * [Contact Sales →](https://enterprise.github.com/contact)
    * [Education →](https://education.github.com)

![](https://github.githubassets.com/images/search-key-slash.svg)

  * [ ![]() In this repository  All GitHub  ↵ Jump to ↵ ]()

  * No suggested jump to results

  * [ ![]() In this repository  All GitHub  ↵ Jump to ↵ ]()
  * [ ![]() In this user  All GitHub  ↵ Jump to ↵ ]()
  * [ ![]() In this repository  All GitHub  ↵ Jump to ↵ ]()

[ Sign in ](/login?return_to=%2Fpreshing%2Fjunction) [ Sign up
](/join?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-
name%3E%2F%3Crepo-name%3E&source=header-repo&source_repo=preshing%2Fjunction)

{{ message }}

#  [preshing](/preshing) / **[junction](/preshing/junction) **

  * [ Notifications ](/login?return_to=%2Fpreshing%2Fjunction)
  * [ Star ](/login?return_to=%2Fpreshing%2Fjunction) [ 1.2k ](/preshing/junction/stargazers)
  * [ Fork ](/login?return_to=%2Fpreshing%2Fjunction) [ 133 ](/preshing/junction/network/members)

Concurrent data structures in C++

[ View license ](/preshing/junction/blob/master/LICENSE)

[ 1.2k stars ](/preshing/junction/stargazers) [ 133 forks
](/preshing/junction/network/members)

[ Star ](/login?return_to=%2Fpreshing%2Fjunction)

[ Notifications ](/login?return_to=%2Fpreshing%2Fjunction)

  * [ Code ](/preshing/junction)
  * [ Issues 13 ](/preshing/junction/issues)
  * [ Pull requests 1 ](/preshing/junction/pulls)
  * [ Actions ](/preshing/junction/actions)
  * [ Projects 0 ](/preshing/junction/projects)
  * [ Wiki ](/preshing/junction/wiki)
  * [ Security ](/preshing/junction/security)
  * [ Insights ](/preshing/junction/pulse)

More

  * [ Code ](/preshing/junction)
  * [ Issues ](/preshing/junction/issues)
  * [ Pull requests ](/preshing/junction/pulls)
  * [ Actions ](/preshing/junction/actions)
  * [ Projects ](/preshing/junction/projects)
  * [ Wiki ](/preshing/junction/wiki)
  * [ Security ](/preshing/junction/security)
  * [ Insights ](/preshing/junction/pulse)

master

Switch branches/tags

Branches Tags

Could not load branches

Nothing to show

[ {{ refName }} default ](https://github.com/preshing/junction/tree/{{
urlEncodedRefName }}) [View all branches](/preshing/junction/branches)

Could not load tags

Nothing to show

[ {{ refName }} default ](https://github.com/preshing/junction/tree/{{
urlEncodedRefName }})

[View all tags](/preshing/junction/tags)

[ **1** branch ](/preshing/junction/branches) [ **0** tags
](/preshing/junction/tags)

[ Go to file ](/preshing/junction/find/master) Code

[ ](https://docs.github.com/articles/which-remote-url-should-i-use)

Clone

HTTPS  GitHub CLI

Use Git or checkout with SVN using the web URL.

Work fast with our official CLI. [Learn more](https://cli.github.com).

  * [ Open with GitHub Desktop ](https://desktop.github.com)
  * [ Download ZIP ](/preshing/junction/archive/refs/heads/master.zip)

#### Launching GitHub Desktop

If nothing happens, [download GitHub Desktop](https://desktop.github.com/) and
try again.

Go back

#### Launching GitHub Desktop

If nothing happens, [download GitHub Desktop](https://desktop.github.com/) and
try again.

Go back

#### Launching Xcode

If nothing happens, [download Xcode](https://developer.apple.com/xcode/) and
try again.

Go back

#### Launching Visual Studio Code

Your codespace will open once ready.

There was a problem preparing your codespace, please try again.

## Latest commit

[ ![@preshing](https://avatars.githubusercontent.com/u/939009?s=48&v=4)
](/preshing)

[preshing](/preshing/junction/commits?author=preshing "View all commits by
preshing") [Clang
fixes](/preshing/junction/commit/5ad3be7ce1d3f16b9f7ed6065bbfeacd2d629a08
"Clang fixes")

…

[ 5ad3be7
](/preshing/junction/commit/5ad3be7ce1d3f16b9f7ed6065bbfeacd2d629a08) [ on 19
Feb 2018 ](/preshing/junction/commit/5ad3be7ce1d3f16b9f7ed6065bbfeacd2d629a08)

[Clang
fixes](/preshing/junction/commit/5ad3be7ce1d3f16b9f7ed6065bbfeacd2d629a08)

5ad3be7

## Git stats

  * [ **43** commits  ](/preshing/junction/commits/master)

## Files

[Permalink](/preshing/junction/tree/5ad3be7ce1d3f16b9f7ed6065bbfeacd2d629a08)

Failed to load latest commit information.

Type

Name

Latest commit message

Commit time

[cmake](/preshing/junction/tree/master/cmake "cmake")

[Simplify CMake
scripts](/preshing/junction/commit/e4342c8333d4f6c5451ae242781be74dfcd4455f
"Simplify CMake scripts

Delete FindTurf.cmake as it was more complicated than necessary.")

5 years ago

[docs](/preshing/junction/tree/master/docs "docs")

[Don't copy CMake scripts to install
folder](/preshing/junction/commit/70b651510a32915a5adeb94ff9b7cfbac6380609
"Don't copy CMake scripts to install folder")

5 years ago

[junction](/preshing/junction/tree/master/junction "junction")

[Clang
fixes](/preshing/junction/commit/5ad3be7ce1d3f16b9f7ed6065bbfeacd2d629a08
"Clang fixes")

3 years ago

[samples](/preshing/junction/tree/master/samples "samples")

[Clang
fixes](/preshing/junction/commit/5ad3be7ce1d3f16b9f7ed6065bbfeacd2d629a08
"Clang fixes")

3 years ago

[.clang-format](/preshing/junction/blob/master/.clang-format ".clang-format")

[Run clang-
format](/preshing/junction/commit/e8d98a04ab8e1fc34bef37bd9b802c49510c9e83
"Run clang-format")

5 years ago

[.gitignore](/preshing/junction/blob/master/.gitignore ".gitignore")

[Fix](/preshing/junction/commit/fdaa2b5b2a5c1d2e40a7b8ffb1616933c9feda6d "Fix
#31: Entries can disappear when deleted key is reassigned during a migration

Bug was in the Mutator classes. In the Mutator constructor: If an existing

cell was found, and that cell's value was Redirect, Mutator::m_value was

assigned to Redirect. The constructor would then loop a second time.

On the second iteration of the loop, if no existing cell was found, a new

cell was inserted, but Mutator::m_value was left set to Redirect. This

left the Mutator in an inconsistent state, so that on the next
exchangeValue\(\),

it thought there was a racing write to the same key \(which there wasn't\),
and

neglected to write the new value.

Fix is to avoid ever setting Mutator::m_value to Redirect.")
[#31](https://github.com/preshing/junction/issues/31)[: Entries can disappear
when deleted key is reassigned during
…](/preshing/junction/commit/fdaa2b5b2a5c1d2e40a7b8ffb1616933c9feda6d "Fix
#31: Entries can disappear when deleted key is reassigned during a migration

Bug was in the Mutator classes. In the Mutator constructor: If an existing

cell was found, and that cell's value was Redirect, Mutator::m_value was

assigned to Redirect. The constructor would then loop a second time.

On the second iteration of the loop, if no existing cell was found, a new

cell was inserted, but Mutator::m_value was left set to Redirect. This

left the Mutator in an inconsistent state, so that on the next
exchangeValue\(\),

it thought there was a racing write to the same key \(which there wasn't\),
and

neglected to write the new value.

Fix is to avoid ever setting Mutator::m_value to Redirect.")

3 years ago

[CMakeLists.txt](/preshing/junction/blob/master/CMakeLists.txt
"CMakeLists.txt")

[Simplify CMake
scripts](/preshing/junction/commit/e4342c8333d4f6c5451ae242781be74dfcd4455f
"Simplify CMake scripts

Delete FindTurf.cmake as it was more complicated than necessary.")

5 years ago

[LICENSE](/preshing/junction/blob/master/LICENSE "LICENSE")

[Add project description to
license](/preshing/junction/commit/0cb26ccc4cbca54af7507aa1015735b9f5d2d418
"Add project description to license")

5 years ago

[README.md](/preshing/junction/blob/master/README.md "README.md")

[Update "Rules and Behavior" to mention
DefaultQSBR.update()](/preshing/junction/commit/c6514a8b6b316d7d4c3201096d5e41c93594a906
"Update "Rules and Behavior" to mention DefaultQSBR.update\(\)")

3 years ago

View code

License Getting Started Adding Junction to Your Project Adding to an Existing
CMake Project Building the Libraries Separately Configuration Rules and
Behavior Feedback

##  README.md

Junction is a library of concurrent data structures in C++. It contains
several hash map implementations:

    
    
    junction::ConcurrentMap_Crude
    junction::ConcurrentMap_Linear
    junction::ConcurrentMap_Leapfrog
    junction::ConcurrentMap_Grampa
    

[CMake](https://cmake.org/) and [Turf](https://github.com/preshing/turf) are
required. See the blog post [New Concurrent Hash Maps for
C++](http://preshing.com/20160201/new-concurrent-hash-maps-for-cpp/) for more
information.

## License

Junction uses the Simplified BSD License. You can use the source code freely
in any project, including commercial applications, as long as you give credit
by publishing the contents of the `LICENSE` file in your documentation
somewhere.

## Getting Started

If you just want to get the code and look around, start by cloning Junction
and Turf into adjacent folders, then run CMake on Junction's `CMakeLists.txt`.
You'll want to pass different arguments to `cmake` depending on your platform
and IDE.

    
    
    $ git clone https://github.com/preshing/junction.git
    $ git clone https://github.com/preshing/turf.git
    $ cd junction
    $ mkdir build
    $ cd build
    $ cmake <additional options> ..
    

On Unix-like environments, `cmake` will generate a Makefile by default. On
Windows, it will create a Visual Studio solution. To use a specific version of
Visual Studio:

    
    
    $ cmake -G "Visual Studio 14 2015" ..
    

To generate an Xcode project on OS X:

    
    
    $ cmake -G "Xcode" ..
    

To generate an Xcode project for iOS:

    
    
    $ cmake -G "Xcode" -DCMAKE_TOOLCHAIN_FILE=../../turf/cmake/toolchains/iOS.cmake ..
    

The generated build system will contain separate targets for Junction, Turf,
and some sample applications.

[![Solution Explorer](/preshing/junction/raw/master/docs/vs-
solution.png)](/preshing/junction/blob/master/docs/vs-solution.png)

Alternatively, you can run CMake on a specific sample only:

    
    
    $ cd junction/samples/MapCorrectnessTests
    $ mkdir build
    $ cd build
    $ cmake <additional options> ..
    

## Adding Junction to Your Project

There are several ways to add Junction to your own C++ project.

  1. Add Junction as a build target in an existing CMake-based project.
  2. Use CMake to build Junction and Turf, then link the static libraries into your own project.
  3. Grab only the source files you need from Junction, copy them to your project and hack them until they build correctly.

Some developers will prefer approach #3, but I encourage you to try approach
#1 or #2 instead. It will be easier to grab future updates that way. There are
plenty of files in Junction (and Turf) that you don't really need, but it
won't hurt to keep them on your hard drive either. And if you link Junction
statically, the linker will exclude the parts that aren't used.

### Adding to an Existing CMake Project

If your project is already based on CMake, clone the Junction and Turf source
trees somewhere, then call `add_subdirectory` on Junction's root folder from
your own CMake script. This will add both Junction and Turf targets to your
build system.

For a simple example, see the [junction-
sample](https://github.com/preshing/junction-sample) repository.

### Building the Libraries Separately

Generate Junction's build system using the steps described in the _Getting
Started_ section, then use it to build the libraries you need. Add these to
your own build system. Make sure to generate static libraries to avoid linking
parts of the library that aren't needed.

If you build the `install` target provided by Junction's CMake script, the
build system will output a clean folder containing only the headers and libs
that you need. You can add this to your own project using a single include
path. Choose the output directory by specifying the `CMAKE_INSTALL_PREFIX`
variable to CMake. Additionally, you can specify `JUNCTION_WITH_SAMPLES=OFF`
to avoid building the samples. For example:

    
    
    $ cmake -DCMAKE_INSTALL_PREFIX=~/junction-install -DJUNCTION_WITH_SAMPLES=OFF ..
    $ cmake --build . --target install --config RelWithDebInfo
    

Notes:

  * Instead of running the second `cmake` command, which runs the build system, you could run your build system directly. For example, `make install` on Unix, or build the INSTALL project in Visual Studio.
  * If using makefiles, you'll probably want to pass the additional option `-DCMAKE_BUILD_TYPE=RelWithDebInfo` to the first `cmake` command.

This will create the following file structure:

[![Install folder](/preshing/junction/raw/master/docs/install-
folder.png)](/preshing/junction/blob/master/docs/install-folder.png)

## Configuration

When you first run CMake on Junction, Turf will detect the capabilities of
your compiler and write the results to a file in the build tree named
`turf/include/turf_config.h`. Similarly, Junction will write
`include/junction_config.h` to the build tree. You can modify the contents of
those files by setting variables when CMake runs. This can be done by passing
additional options to `cmake`, or by using an interactive GUI such as `cmake-
gui` or `ccmake`.

For example, to configure Turf to use the C++11 standard library, you can set
the `TURF_PREFER_CPP11` variable on the command line:

    
    
    $ cmake -DTURF_PREFER_CPP11=1 ..
    

Or, using the CMake GUI:

[![CMake GUI](/preshing/junction/raw/master/docs/cmake-
gui.png)](/preshing/junction/blob/master/docs/cmake-gui.png)

Many header files in Turf, and some in Junction, are configurable using
preprocessor definitions. For example, `turf/Thread.h` will switch between
`turf::Thread` implementations depending on the values of
`TURF_IMPL_THREAD_PATH` and `TURF_IMPL_THREAD_TYPE`. If those macros are not
defined, they will be set to default values based on information from the
environment. You can set them directly by providing your own header file and
passing it in the `TURF_USERCONFIG` variable when CMake runs. You can place
this file anywhere; CMake will copy it to Turf's build tree right next to
`include/turf_config.h`.

    
    
    $ cmake -DTURF_USERCONFIG=path/to/custom/turf_userconfig.h.in ..
    

The `JUNCTION_USERCONFIG` variable works in a similar way. As an example, take
a look at the Python script
`junction/samples/MapScalabilityTests/TestAllMaps.py`. This script invokes
`cmake` several times, passing a different `junction_userconfig.h.in` file
each time. That's how it builds the same test application using different map
implementations.

## Rules and Behavior

Currently, Junction maps only work with keys and values that are pointers or
pointer-sized integers. The hash function must be invertible, so that every
key has a unique hash. Out of all possible keys, a _null_ key must be
reserved, and out of all possible values, _null_ and _redirect_ values must be
reserved. The defaults are 0 and 1. You can override those defaults by passing
custom `KeyTraits` and `ValueTraits` parameters to the template.

Every thread that manipulates a Junction map must periodically call
`junction::DefaultQSBR.update`, as mentioned [in the blog
post](http://preshing.com/20160201/new-concurrent-hash-maps-for-cpp/). If not,
the application will leak memory.

Otherwise, a Junction map is a lot like a big array of `std::atomic<>`
variables, where the key is an index into the array. More precisely:

  * All of a Junction map's member functions, together with its `Mutator` member functions, are atomic with respect to each other, so you can safely call them from any thread without mutual exclusion.
  * If an `assign` [happens before](http://preshing.com/20130702/the-happens-before-relation/) a `get` with the same key, the `get` will return the value it inserted, except if another operation changes the value in between. Any [synchronizing operation](http://preshing.com/20130823/the-synchronizes-with-relation/) will establish this relationship.
  * For Linear, Leapfrog and Grampa maps, `assign` is a [release](http://preshing.com/20120913/acquire-and-release-semantics/) operation and `get` is a [consume](http://preshing.com/20140709/the-purpose-of-memory_order_consume-in-cpp11/) operation, so you can safely pass non-atomic information between threads using a pointer. For Crude maps, all operations are relaxed.
  * In the current version, you must not `assign` while concurrently using an `Iterator`.

## Feedback

If you have any feedback on improving these steps, feel free to [open an
issue](https://github.com/preshing/junction/issues) on GitHub, or send a
direct message using the [contact form](http://preshing.com/contact/) on my
blog.

## About

Concurrent data structures in C++

### Resources

Readme

### License

[ View license ](/preshing/junction/blob/master/LICENSE)

##  [ Releases ](/preshing/junction/releases)

No releases published

##  [ Packages 0 ](/users/preshing/packages?repo_name=junction)

No packages published  

##  [ Contributors 4 ](/preshing/junction/graphs/contributors)

  * [ ![@preshing](https://avatars.githubusercontent.com/u/939009?s=64&v=4) ](/preshing) [ **preshing** Jeff Preshing ](/preshing)
  * [ ![@mdw55189](https://avatars.githubusercontent.com/u/1664087?s=64&v=4) ](/mdw55189) [ **mdw55189** Matt Weiss ](/mdw55189)
  * [ ![@zuyu](https://avatars.githubusercontent.com/u/2245572?s=64&v=4) ](/zuyu) [ **zuyu** zuyu ](/zuyu)
  * [ ![@richardkogelnig](https://avatars.githubusercontent.com/u/3049909?s=64&v=4) ](/richardkogelnig) [ **richardkogelnig** Richard Kogelnig ](/richardkogelnig)

## Languages

  * [ C++ 92.9% ](/preshing/junction/search?l=c%2B%2B)
  * [ CMake 6.8% ](/preshing/junction/search?l=cmake)
  * [ C 0.3% ](/preshing/junction/search?l=c)

  * © 2021 GitHub, Inc.
  * [Terms](https://docs.github.com/en/github/site-policy/github-terms-of-service)
  * [Privacy](https://docs.github.com/en/github/site-policy/github-privacy-statement)
  * [Security](https://github.com/security)
  * [Status](https://www.githubstatus.com/)
  * [Docs](https://docs.github.com)

[ ](https://github.com "GitHub")

  * [Contact GitHub](https://support.github.com)
  * [Pricing](https://github.com/pricing)
  * [API](https://docs.github.com)
  * [Training](https://services.github.com)
  * [Blog](https://github.blog)
  * [About](https://github.com/about)

You can’t perform that action at this time.

You signed in with another tab or window. [Reload]() to refresh your session.
You signed out in another tab or window. [Reload]() to refresh your session.

